<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>信用卡管理</title>
  <style>
    :root {
      --bg: #f7efe2;
      --card: #fffaf4;
      --line: #e5d7c8;
      --text: #46362d;
      --subtle: #7a6357;
      --accent: #b57542;
      --accent-deep: #975d33;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color: var(--text);
      background: var(--bg);
      padding: 16px;
    }
    .wrap {
      width: 100%;
      max-width: 820px;
      margin: 0 auto;
      display: grid;
      gap: 12px;
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--card);
      padding: 14px;
      display: grid;
      gap: 10px;
    }
    h1 { margin: 0; font-size: 1.15rem; }
    p { margin: 0; color: var(--subtle); font-size: 0.9rem; }
    .grid {
      display: grid;
      gap: 8px;
      grid-template-columns: 1.2fr 1fr auto;
    }
    input, select, button, a {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      min-height: 44px;
      font-size: 0.92rem;
      color: var(--text);
      background: #fff9f2;
      text-decoration: none;
    }
    button { cursor: pointer; }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff8f0;
    }
    .btn-primary:hover {
      background: var(--accent-deep);
      border-color: var(--accent-deep);
    }
    .list { display: grid; gap: 8px; }
    .row {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fffdf9;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .meta { color: var(--subtle); font-size: 0.82rem; }
    .head { display: flex; justify-content: space-between; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row-actions { display: inline-flex; gap: 6px; }
    .tiny-btn { font-size: 0.8rem; padding: 6px 8px; }
    @media (max-width: 520px) {
      body { padding: 10px; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="head">
        <h1>信用卡管理</h1>
        <a href="./index.html">返回記帳首頁</a>
      </div>
      <p>設定信用卡名稱與繳款日（每月幾號）。記帳時可選擇使用哪張卡消費。</p>
    </section>

    <section class="card">
      <div class="grid">
        <input id="cardName" type="text" placeholder="信用卡名稱（如：主卡）" />
        <input id="dueDay" type="number" min="1" max="28" placeholder="繳款日（1-28）" value="15" />
        <button id="addBtn" type="button" class="btn-primary">新增</button>
      </div>
      <div id="cardList" class="list"></div>
    </section>
  </main>

  <script>
    const CREDIT_CARD_STORAGE_KEY = "money-app-credit-cards-v1";
    const LAST_LOCAL_DATA_UPDATE_KEY = "money-app-last-local-data-update-at";
    const DEFAULT_CREDIT_CARDS = [
      { id: "cc-1", name: "主卡", dueDay: 15 },
      { id: "cc-2", name: "副卡", dueDay: 25 }
    ];

    const cardNameInput = document.getElementById("cardName");
    const dueDayInput = document.getElementById("dueDay");
    const addBtn = document.getElementById("addBtn");
    const cardList = document.getElementById("cardList");

    let creditCards = [];

    function normalizeCreditCards(input) {
      const seed = Array.isArray(input) && input.length ? input : DEFAULT_CREDIT_CARDS;
      const normalized = seed.map((card, index) => {
        if (!card || typeof card.name !== "string") return null;
        const name = card.name.trim();
        if (!name) return null;
        const id = String(card.id || `cc-${Date.now()}-${index}`).trim();
        const dueDay = Math.min(28, Math.max(1, Number(card.dueDay) || 15));
        return { id, name, dueDay };
      }).filter(Boolean);
      return normalized.length ? normalized : DEFAULT_CREDIT_CARDS.slice();
    }

    function loadCreditCards() {
      try {
        const raw = localStorage.getItem(CREDIT_CARD_STORAGE_KEY);
        creditCards = normalizeCreditCards(raw ? JSON.parse(raw) : null);
      } catch {
        creditCards = normalizeCreditCards(null);
      }
      if (!localStorage.getItem(CREDIT_CARD_STORAGE_KEY)) {
        localStorage.setItem(CREDIT_CARD_STORAGE_KEY, JSON.stringify(creditCards));
      }
    }

    function saveCreditCards() {
      localStorage.setItem(LAST_LOCAL_DATA_UPDATE_KEY, new Date().toISOString());
      localStorage.setItem(CREDIT_CARD_STORAGE_KEY, JSON.stringify(creditCards));
    }

    function escapeHtml(text) {
      return String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function renderCards() {
      cardList.innerHTML = "";
      creditCards.forEach((card) => {
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.id = card.id;
        row.innerHTML = `
          <div>
            <div>${escapeHtml(card.name)}</div>
            <div class="meta">每月 ${card.dueDay} 日繳款</div>
          </div>
          <div class="row-actions">
            <button type="button" class="tiny-btn" data-action="delete" data-id="${card.id}">刪除</button>
          </div>
        `;
        cardList.appendChild(row);
      });
    }

    function addCard() {
      const name = String(cardNameInput.value || "").trim();
      const dueDay = Math.min(28, Math.max(1, Number(dueDayInput.value) || 15));
      if (!name) {
        alert("請輸入信用卡名稱。");
        return;
      }
      if (creditCards.some((c) => c.name === name)) {
        alert("已存在同名稱的信用卡。");
        return;
      }
      creditCards.push({
        id: `cc-${Date.now()}`,
        name,
        dueDay
      });
      saveCreditCards();
      renderCards();
      cardNameInput.value = "";
      dueDayInput.value = "15";
      alert("已新增信用卡。");
    }

    cardList.addEventListener("click", (event) => {
      const btn = event.target.closest("button");
      if (!btn || btn.dataset.action !== "delete") return;
      const id = btn.dataset.id;
      if (!id) return;
      if (!confirm("確定要刪除此信用卡嗎？相關消費紀錄的信用卡欄位將被清空。")) return;
      creditCards = creditCards.filter((c) => c.id !== id);
      saveCreditCards();
      renderCards();
      alert("已刪除。");
    });

    addBtn.addEventListener("click", addCard);
    loadCreditCards();
    renderCards();
  </script>
</body>
</html>
