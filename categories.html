<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#b57542" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./app-icon.svg" type="image/svg+xml" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>é¡åˆ¥ç®¡ç† - è¨˜å¸³ App</title>
  <style>
    :root {
      --bg: #f7efe2;
      --card: rgba(255, 250, 244, 0.92);
      --text: #46362d;
      --subtle: #7a6357;
      --line: #e5d7c8;
      --accent: #b57542;
      --accent-deep: #975d33;
      --danger: #ab5c52;
      --shadow: 0 10px 24px rgba(92, 57, 34, 0.12);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(circle at 6% 10%, rgba(255, 255, 255, 0.75) 0 16%, transparent 17%),
        radial-gradient(circle at 92% 12%, rgba(247, 206, 182, 0.35) 0 18%, transparent 19%),
        radial-gradient(circle at 90% 82%, rgba(240, 176, 140, 0.22) 0 24%, transparent 25%),
        linear-gradient(160deg, #f9f1e5 0%, #f0dfcb 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 16px;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      left: -45px;
      top: -35px;
      opacity: 0.48;
      background:
        radial-gradient(circle at 50% 50%, #f2b9a4 0 22%, transparent 23%),
        radial-gradient(circle at 28% 30%, #f8d8bb 0 18%, transparent 19%),
        radial-gradient(circle at 76% 30%, #edbf9a 0 18%, transparent 19%),
        radial-gradient(circle at 30% 74%, #df9f85 0 18%, transparent 19%),
        radial-gradient(circle at 74% 74%, #f7c8b4 0 18%, transparent 19%),
        radial-gradient(circle at 50% 50%, #fbeee0 0 60%, transparent 61%);
    }

    body::after {
      right: -45px;
      bottom: -35px;
      opacity: 0.46;
      background:
        radial-gradient(circle at 50% 50%, #f4caa2 0 20%, transparent 21%),
        radial-gradient(circle at 28% 32%, #f8e4c6 0 18%, transparent 19%),
        radial-gradient(circle at 74% 32%, #e8bb86 0 18%, transparent 19%),
        radial-gradient(circle at 32% 74%, #edce9c 0 18%, transparent 19%),
        radial-gradient(circle at 72% 74%, #f7dfbf 0 18%, transparent 19%),
        radial-gradient(circle at 50% 50%, #fbf2e3 0 60%, transparent 61%);
    }

    .app {
      width: min(860px, 100%);
      margin: 0 auto;
      display: grid;
      gap: 18px;
      position: relative;
      z-index: 1;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
      backdrop-filter: blur(4px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--subtle);
      font-size: 0.9rem;
    }

    .btn-link,
    button,
    input {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.93rem;
      background: #fff9f2;
      color: var(--text);
      text-decoration: none;
    }

    button {
      cursor: pointer;
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff8f0;
    }

    .btn-primary:hover {
      background: var(--accent-deep);
      border-color: var(--accent-deep);
    }

    .btn-danger {
      color: var(--danger);
      background: #fff2f0;
      border-color: #e3c8c2;
      padding: 6px 10px;
      font-size: 0.82rem;
    }

    .toolbar {
      margin-top: 14px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .form {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 2fr 4fr auto;
      gap: 10px;
    }

    .tip {
      margin: 8px 0 0;
      color: var(--subtle);
      font-size: 0.85rem;
    }

    .list {
      margin-top: 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      background: #fffaf4;
    }

    .row {
      display: grid;
      grid-template-columns: 36px 120px 1fr auto;
      gap: 8px;
      padding: 12px;
      border-bottom: 1px solid var(--line);
      align-items: center;
      font-size: 0.92rem;
      background: #fffaf4;
    }

    .row:last-child {
      border-bottom: none;
    }

    .row.dragging {
      opacity: 0.5;
    }

    .row.drag-over {
      box-shadow: inset 0 0 0 2px rgba(181, 117, 66, 0.28);
      background: #f8eddc;
    }

    .drag-handle {
      text-align: center;
      color: #9c7f6e;
      user-select: none;
      font-size: 1rem;
      cursor: grab;
    }

    .name {
      font-weight: 700;
    }

    .keywords {
      color: #6c5649;
    }

    .empty {
      padding: 16px;
      color: var(--subtle);
      text-align: center;
    }

    .conflict-box {
      margin-top: 14px;
      border: 1px solid #edd1cb;
      border-radius: 12px;
      background: #fff4f2;
      padding: 12px;
    }

    .conflict-title {
      margin: 0 0 8px;
      color: #9a4f44;
      font-size: 0.92rem;
      font-weight: 700;
    }

    .conflict-list {
      margin: 0;
      padding-left: 18px;
      color: #734842;
      font-size: 0.87rem;
      display: grid;
      gap: 4px;
    }

    .success-tip {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--subtle);
      min-height: 18px;
    }

    .robot-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 62px;
      height: 62px;
      border-radius: 50%;
      border: 1px solid #e3c2a3;
      background: linear-gradient(145deg, #f6dec1, #f0c899);
      box-shadow: 0 8px 18px rgba(129, 81, 46, 0.25);
      font-size: 1.5rem;
      z-index: 30;
    }
    .robot-panel {
      position: fixed;
      right: 18px;
      bottom: 92px;
      width: min(360px, calc(100vw - 24px));
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #fff8ef;
      box-shadow: var(--shadow);
      padding: 12px;
      z-index: 30;
      display: none;
    }
    .robot-panel.show { display: block; }
    .tool-title { margin: 0 0 8px; color: #6f4d3a; font-size: 0.93rem; font-weight: 700; }
    .tool-list { margin: 0 0 10px; padding-left: 18px; color: var(--subtle); font-size: 0.86rem; line-height: 1.55; }
    .calc { border: 1px solid var(--line); border-radius: 12px; padding: 10px; background: #fbf1e3; }
    .calc-screen { width: 100%; margin-bottom: 8px; text-align: right; font-weight: 700; font-size: 1rem; background: #fff8f0; }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .calc-grid button { padding: 9px 0; font-weight: 700; }
    @media (max-width: 760px) {
      .form { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
      .robot-btn { width: 54px; height: 54px; right: 12px; bottom: 12px; }
      .robot-panel { right: 12px; bottom: 76px; }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <div class="header">
        <div>
          <h1>é¡åˆ¥ç®¡ç†</h1>
          <p class="subtitle">æŸ¥çœ‹èˆ‡æ–°å¢åˆ†é¡é—œéµå­—ï¼Œä¾›ä¸»é è‡ªå‹•åˆ†é¡ä½¿ç”¨</p>
        </div>
        <a class="btn-link" href="index.html">è¿”å›è¨˜å¸³</a>
      </div>

      <form id="categoryForm" class="form">
        <input id="categoryName" type="text" placeholder="é¡åˆ¥åç¨±ï¼ˆä¾‹å¦‚ï¼šé£Ÿï¼‰" required />
        <input id="categoryKeywords" type="text" placeholder="é—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šåˆé¤,ç«é‹,é£²æ–™ï¼‰" required />
        <button class="btn-primary" type="submit">æ–°å¢é¡åˆ¥</button>
      </form>
      <div class="toolbar">
        <button id="exportBtn" type="button">åŒ¯å‡º JSON</button>
        <button id="importBtn" type="button">åŒ¯å…¥ JSON</button>
        <input id="importFile" type="file" accept="application/json" hidden />
      </div>
      <p class="tip">æç¤ºï¼šå¯æ‹–æ›³æ’åºï¼Œæ’åºè¶Šå‰é¢æœƒå„ªå…ˆè¢«ä¸»é è‡ªå‹•åˆ†é¡å‘½ä¸­ï¼›è‹¥åç¨±é‡è¤‡ï¼ŒæœƒæŠŠé—œéµå­—åˆä½µé€²åŸé¡åˆ¥ã€‚</p>
      <p id="message" class="success-tip"></p>

      <div class="list" id="categoryList"></div>
      <div id="conflictBox" class="conflict-box" hidden>
        <p class="conflict-title">é—œéµå­—è¡çªæé†’ï¼ˆåŒé—œéµå­—å­˜åœ¨æ–¼å¤šå€‹é¡åˆ¥ï¼‰</p>
        <ul id="conflictList" class="conflict-list"></ul>
      </div>
    </section>
  </main>

  <button id="robotBtn" class="robot-btn" title="é–‹å•Ÿå°å¹«æ‰‹">ğŸ¤–</button>
  <aside id="robotPanel" class="robot-panel" aria-hidden="true">
    <p class="tool-title">å°å¹«æ‰‹å·¥å…·ç®±</p>
    <ol class="tool-list">
      <li>è¨ˆç®—æ©Ÿï¼Œç›´æ¥åœ¨é é¢æ—å”åŠ©ä½ åšç°¡å–®è¨ˆç®—</li>
    </ol>
    <section id="toolCalculator" class="tool-body" style="display:block;">
      <div class="calc">
        <input id="calcScreen" class="calc-screen" type="text" value="0" readonly />
        <div class="calc-grid" id="calcGrid">
          <button type="button" data-action="clear">C</button>
          <button type="button" data-action="delete">DEL</button>
          <button type="button" data-value="%">%</button>
          <button type="button" data-value="/">/</button>
          <button type="button" data-value="7">7</button>
          <button type="button" data-value="8">8</button>
          <button type="button" data-value="9">9</button>
          <button type="button" data-value="*">*</button>
          <button type="button" data-value="4">4</button>
          <button type="button" data-value="5">5</button>
          <button type="button" data-value="6">6</button>
          <button type="button" data-value="-">-</button>
          <button type="button" data-value="1">1</button>
          <button type="button" data-value="2">2</button>
          <button type="button" data-value="3">3</button>
          <button type="button" data-value="+">+</button>
          <button type="button" data-value="0">0</button>
          <button type="button" data-value=".">.</button>
          <button type="button" data-action="equal" style="grid-column: span 2;">=</button>
        </div>
      </div>
    </section>
  </aside>

  <script>
    const CATEGORY_STORAGE_KEY = "money-app-categories-v1";
    const RECORD_STORAGE_KEY = "money-app-records-v1";
    const PROJECT_STORAGE_KEY = "money-app-projects-v1";
    const SUPABASE_URL_KEY = "money-app-supabase-url";
    const SUPABASE_ANON_KEY = "money-app-supabase-anon-key";
    const SUPABASE_DEFAULT_URL = "https://wbirxxapsemulrsjjqao.supabase.co";
    const SUPABASE_DEFAULT_ANON_KEY = "sb_publishable_toooZNwiSeEG6YAHD9qrZA_0GA7xNYi";
    const SYNC_TABLE = "money_sync_state";
    const SYNC_ROW_ID = "main";
    const SYNC_KEY_COLUMN = "sync_key";
    const SYNC_PAYLOAD_COLUMN = "sync_payload";
    const SYNC_UPDATED_AT_COLUMN = "sync_updated_at";
    const DEFAULT_CATEGORIES = [
      { name: "é£Ÿ", keywords: ["åˆé¤", "æ—©é¤", "æ™šé¤", "ç«é‹", "é£²æ–™", "å’–å•¡", "ä¾¿ç•¶"] },
      { name: "è¡Œ", keywords: ["å…¬è»Š", "æ·é‹", "åŠ æ²¹", "è¨ˆç¨‹è»Š", "åœè»Š", "é«˜éµ", "ç«è»Š"] },
      { name: "è¡£", keywords: ["è¡£æœ", "é‹å­", "å¤–å¥—", "è¤²å­", "å¸½å­", "é…ä»¶"] },
      { name: "ä½", keywords: ["æˆ¿ç§Ÿ", "æ°´è²»", "é›»è²»", "ç“¦æ–¯", "ç¶²è·¯"] },
      { name: "è‚²æ¨‚", keywords: ["é›»å½±", "èª²ç¨‹", "æ›¸ç±", "éŠæˆ²", "æ—…è¡Œ"] }
    ];

    const form = document.getElementById("categoryForm");
    const nameInput = document.getElementById("categoryName");
    const keywordsInput = document.getElementById("categoryKeywords");
    const categoryList = document.getElementById("categoryList");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");
    const conflictBox = document.getElementById("conflictBox");
    const conflictList = document.getElementById("conflictList");
    const messageEl = document.getElementById("message");

    let categories = [];
    let dragIndex = null;

    function normalizeCategories(input) {
      if (!Array.isArray(input) || input.length === 0) {
        return DEFAULT_CATEGORIES;
      }

      const cleaned = input
        .map((item) => {
          if (!item || typeof item.name !== "string") return null;
          const name = item.name.trim();
          if (!name) return null;
          const keywords = Array.isArray(item.keywords)
            ? item.keywords
                .map((word) => String(word || "").trim())
                .filter(Boolean)
            : [];
          return { name, keywords };
        })
        .filter(Boolean);

      return cleaned.length ? cleaned : DEFAULT_CATEGORIES;
    }

    function loadCategories() {
      try {
        const raw = localStorage.getItem(CATEGORY_STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        categories = normalizeCategories(parsed);
      } catch {
        categories = normalizeCategories(null);
      }
      saveCategories();
    }

    function saveCategories() {
      localStorage.setItem(CATEGORY_STORAGE_KEY, JSON.stringify(categories));
      saveToCloud();
    }

    function getSupabaseConfig() {
      const url = (localStorage.getItem(SUPABASE_URL_KEY) || SUPABASE_DEFAULT_URL).trim();
      const anonKey = (localStorage.getItem(SUPABASE_ANON_KEY) || SUPABASE_DEFAULT_ANON_KEY).trim();
      return { url, anonKey };
    }
    function isSupabaseConfigured() {
      const { url, anonKey } = getSupabaseConfig();
      return url.length > 0 && anonKey.length > 0;
    }
    function getSupabaseHeaders() {
      const { anonKey } = getSupabaseConfig();
      return {
        apikey: anonKey,
        "Content-Type": "application/json"
      };
    }
    async function loadFromCloud() {
      if (!navigator.onLine || !isSupabaseConfigured()) return;
      try {
        const { url } = getSupabaseConfig();
        const endpoint = `${url}/rest/v1/${SYNC_TABLE}?select=${SYNC_PAYLOAD_COLUMN}&${SYNC_KEY_COLUMN}=eq.${encodeURIComponent(SYNC_ROW_ID)}`;
        const response = await fetch(endpoint, {
          method: "GET",
          headers: getSupabaseHeaders()
        });
        if (!response.ok) return;
        const rows = await response.json();
        const p = Array.isArray(rows) && rows[0] && rows[0][SYNC_PAYLOAD_COLUMN] ? rows[0][SYNC_PAYLOAD_COLUMN] : null;
        if (!p) return;
        if (Array.isArray(p.records)) localStorage.setItem(RECORD_STORAGE_KEY, JSON.stringify(p.records));
        if (p.categories != null) localStorage.setItem(CATEGORY_STORAGE_KEY, JSON.stringify(p.categories));
        if (p.projects != null) localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(p.projects));
      } catch (_) {}
    }
    async function saveToCloud() {
      if (!navigator.onLine || !isSupabaseConfigured()) return;
      try {
        const { url } = getSupabaseConfig();
        const records = JSON.parse(localStorage.getItem(RECORD_STORAGE_KEY) || "[]");
        const projects = JSON.parse(localStorage.getItem(PROJECT_STORAGE_KEY) || "[]");
        const endpoint = `${url}/rest/v1/${SYNC_TABLE}?on_conflict=${SYNC_KEY_COLUMN}`;
        await fetch(endpoint, {
          method: "POST",
          headers: {
            ...getSupabaseHeaders(),
            Prefer: "resolution=merge-duplicates,return=minimal"
          },
          body: JSON.stringify([
            {
              [SYNC_KEY_COLUMN]: SYNC_ROW_ID,
              [SYNC_PAYLOAD_COLUMN]: { records, categories, projects },
              [SYNC_UPDATED_AT_COLUMN]: new Date().toISOString()
            }
          ])
        });
      } catch (_) {}
    }

    function renderCategories() {
      categoryList.innerHTML = "";

      if (!categories.length) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "ç›®å‰æ²’æœ‰ä»»ä½•é¡åˆ¥ã€‚";
        categoryList.appendChild(empty);
        renderConflicts();
        return;
      }

      categories.forEach((category, index) => {
        const row = document.createElement("div");
        row.className = "row";
        row.draggable = true;
        row.dataset.index = String(index);

        const handle = document.createElement("div");
        handle.className = "drag-handle";
        handle.textContent = "â‹®â‹®";
        handle.title = "æ‹–æ›³èª¿æ•´å„ªå…ˆé †åº";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = category.name;

        const keywords = document.createElement("div");
        keywords.className = "keywords";
        keywords.textContent = category.keywords.join("ã€") || "ï¼ˆç„¡é—œéµå­—ï¼‰";

        const actionWrap = document.createElement("div");
        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger";
        delBtn.type = "button";
        delBtn.dataset.name = category.name;
        delBtn.textContent = "åˆªé™¤";
        actionWrap.appendChild(delBtn);

        row.appendChild(handle);
        row.appendChild(name);
        row.appendChild(keywords);
        row.appendChild(actionWrap);

        categoryList.appendChild(row);
      });

      renderConflicts();
    }

    function escapeHtml(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function showMessage(text) {
      messageEl.textContent = text;
      window.clearTimeout(showMessage.timerId);
      showMessage.timerId = window.setTimeout(() => {
        messageEl.textContent = "";
      }, 3000);
    }

    function parseKeywords(raw) {
      return raw
        .split(",")
        .map((word) => word.trim())
        .filter(Boolean);
    }

    function buildConflictEntries() {
      const keywordMap = new Map();
      categories.forEach((category) => {
        category.keywords.forEach((keyword) => {
          const key = keyword.toLowerCase();
          if (!keywordMap.has(key)) {
            keywordMap.set(key, { keyword, owners: new Set() });
          }
          keywordMap.get(key).owners.add(category.name);
        });
      });

      return Array.from(keywordMap.values()).filter((entry) => entry.owners.size > 1);
    }

    function renderConflicts() {
      const conflicts = buildConflictEntries();
      conflictList.innerHTML = "";

      if (conflicts.length === 0) {
        conflictBox.hidden = true;
        return;
      }

      conflicts.forEach((entry) => {
        const li = document.createElement("li");
        li.textContent = `ã€Œ${entry.keyword}ã€åŒæ™‚å‡ºç¾åœ¨ï¼š${Array.from(entry.owners).join("ã€")}`;
        conflictList.appendChild(li);
      });
      conflictBox.hidden = false;
    }

    function moveCategory(from, to) {
      if (from === to || from < 0 || to < 0 || from >= categories.length || to >= categories.length) {
        return;
      }
      const [moved] = categories.splice(from, 1);
      categories.splice(to, 0, moved);
      saveCategories();
      renderCategories();
      showMessage("å·²æ›´æ–°é¡åˆ¥å„ªå…ˆé †åº");
    }

    form.addEventListener("submit", (event) => {
      event.preventDefault();

      const name = nameInput.value.trim();
      const keywords = parseKeywords(keywordsInput.value);

      if (!name || keywords.length === 0) {
        alert("è«‹è¼¸å…¥é¡åˆ¥åç¨±èˆ‡è‡³å°‘ä¸€å€‹é—œéµå­—ã€‚");
        return;
      }

      const existing = categories.find((item) => item.name === name);
      if (existing) {
        existing.keywords = Array.from(new Set([...existing.keywords, ...keywords]));
      } else {
        categories.push({ name, keywords });
      }

      saveCategories();
      renderCategories();
      form.reset();
      nameInput.focus();
      showMessage("é¡åˆ¥å·²å„²å­˜");
    });

    categoryList.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.matches(".btn-danger")) return;

      const name = target.dataset.name;
      if (!name) return;

      categories = categories.filter((item) => item.name !== name);
      saveCategories();
      renderCategories();
      showMessage("å·²åˆªé™¤é¡åˆ¥");
    });

    categoryList.addEventListener("dragstart", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const row = target.closest(".row");
      if (!row) return;

      dragIndex = Number(row.dataset.index);
      row.classList.add("dragging");
    });

    categoryList.addEventListener("dragend", () => {
      dragIndex = null;
      categoryList.querySelectorAll(".row").forEach((row) => {
        row.classList.remove("dragging");
        row.classList.remove("drag-over");
      });
    });

    categoryList.addEventListener("dragover", (event) => {
      event.preventDefault();
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const row = target.closest(".row");
      if (!row) return;

      categoryList.querySelectorAll(".row").forEach((item) => item.classList.remove("drag-over"));
      row.classList.add("drag-over");
    });

    categoryList.addEventListener("drop", (event) => {
      event.preventDefault();
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const row = target.closest(".row");
      if (!row || dragIndex === null) return;

      const dropIndex = Number(row.dataset.index);
      categoryList.querySelectorAll(".row").forEach((item) => item.classList.remove("drag-over"));
      moveCategory(dragIndex, dropIndex);
    });

    exportBtn.addEventListener("click", () => {
      const payload = JSON.stringify(categories, null, 2);
      const blob = new Blob([payload], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10);
      link.href = url;
      link.download = `money-app-categories-${date}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showMessage("å·²åŒ¯å‡º JSON");
    });

    importBtn.addEventListener("click", () => {
      importFile.click();
    });

    importFile.addEventListener("change", async () => {
      const file = importFile.files && importFile.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        const next = normalizeCategories(parsed);
        categories = next;
        saveCategories();
        renderCategories();
        showMessage("å·²åŒ¯å…¥é¡åˆ¥è¨­å®š");
      } catch {
        alert("åŒ¯å…¥å¤±æ•—ï¼šè«‹ç¢ºèª JSON æ ¼å¼æ­£ç¢ºã€‚");
      } finally {
        importFile.value = "";
      }
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }

    (async function init() {
      await loadFromCloud();
      loadCategories();
      renderCategories();
    })();

    (function initRobot() {
      const robotBtn = document.getElementById("robotBtn");
      const robotPanel = document.getElementById("robotPanel");
      const calcScreen = document.getElementById("calcScreen");
      const calcGrid = document.getElementById("calcGrid");
      let calcExpression = "0";
      function safeEval(expr) {
        const n = (expr || "").replace(/%/g, "/100");
        if (!/^[\d+\-*/().\s]+$/.test(n)) return null;
        try {
          const r = Function('"use strict"; return (' + n + ');')();
          return Number.isFinite(r) ? r : null;
        } catch { return null; }
      }
      if (robotBtn && robotPanel) {
        robotBtn.addEventListener("click", () => {
          robotPanel.classList.toggle("show");
          robotPanel.setAttribute("aria-hidden", robotPanel.classList.contains("show") ? "false" : "true");
        });
      }
      if (calcGrid && calcScreen) {
        calcGrid.addEventListener("click", (e) => {
          const btn = e.target;
          if (!(btn instanceof HTMLButtonElement)) return;
          const { value, action } = btn.dataset;
          if (action === "clear") calcExpression = "0";
          else if (action === "delete") calcExpression = calcExpression.length > 1 ? calcExpression.slice(0, -1) : "0";
          else if (action === "equal") { const r = safeEval(calcExpression); calcExpression = r === null ? "éŒ¯èª¤" : String(r); }
          else if (value) calcExpression = (calcExpression === "0" || calcExpression === "éŒ¯èª¤") ? value : calcExpression + value;
          calcScreen.value = calcExpression;
        });
      }
    })();
  </script>
</body>
</html>
