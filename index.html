<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#b57542" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="æš–æš–è¨˜å¸³" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./app-icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./app-icon.svg" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>æš–ç³»è¨˜å¸³ App</title>
  <style>
    :root {
      --bg: #f7efe2;
      --bg-soft: #fdf8f1;
      --card: rgba(255, 250, 244, 0.9);
      --text: #46362d;
      --subtle: #7a6357;
      --line: #e5d7c8;
      --accent: #b57542;
      --accent-deep: #975d33;
      --danger: #ab5c52;
      --income: #6d8b5a;
      --expense: #b86e5d;
      --radius: 18px;
      --shadow: 0 10px 24px rgba(92, 57, 34, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 12%, rgba(255, 255, 255, 0.75) 0 16%, transparent 17%),
        radial-gradient(circle at 88% 10%, rgba(247, 206, 182, 0.35) 0 18%, transparent 19%),
        radial-gradient(circle at 90% 82%, rgba(240, 176, 140, 0.22) 0 24%, transparent 25%),
        linear-gradient(160deg, #f9f1e5 0%, #f0dfcb 100%);
      position: relative;
      overflow-x: hidden;
      padding:
        calc(16px + env(safe-area-inset-top))
        14px
        calc(80px + env(safe-area-inset-bottom));
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
      filter: blur(0.2px);
    }

    body::before {
      left: -40px;
      top: -30px;
      background:
        radial-gradient(circle at 52% 52%, #f2b9a4 0 22%, transparent 23%),
        radial-gradient(circle at 28% 30%, #f8d8bb 0 18%, transparent 19%),
        radial-gradient(circle at 76% 30%, #edbf9a 0 18%, transparent 19%),
        radial-gradient(circle at 30% 74%, #df9f85 0 18%, transparent 19%),
        radial-gradient(circle at 74% 74%, #f7c8b4 0 18%, transparent 19%),
        radial-gradient(circle at 50% 50%, #fbeee0 0 60%, transparent 61%);
      opacity: 0.5;
    }

    body::after {
      right: -50px;
      bottom: -40px;
      background:
        radial-gradient(circle at 50% 50%, #f4caa2 0 20%, transparent 21%),
        radial-gradient(circle at 28% 32%, #f8e4c6 0 18%, transparent 19%),
        radial-gradient(circle at 74% 32%, #e8bb86 0 18%, transparent 19%),
        radial-gradient(circle at 32% 74%, #edce9c 0 18%, transparent 19%),
        radial-gradient(circle at 72% 74%, #f7dfbf 0 18%, transparent 19%),
        radial-gradient(circle at 50% 50%, #fbf2e3 0 60%, transparent 61%);
      opacity: 0.45;
    }

    .app {
      width: 100%;
      max-width: 1080px;
      margin: 0 auto;
      padding: 0 16px;
      position: relative;
      z-index: 1;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(4px);
    }

    .header {
      padding: 22px 22px 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .header-right {
      display: flex;
      gap: 8px;
    }

    h1 {
      margin: 0;
      font-size: 1.55rem;
      letter-spacing: 0.02em;
    }

    .subtitle {
      margin: 7px 0 0;
      color: var(--subtle);
      font-size: 0.94rem;
    }

    .btn-link,
    button,
    input,
    select {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px 14px;
      min-height: 46px;
      font-size: 0.94rem;
      color: var(--text);
      background: #fff9f2;
      text-decoration: none;
      line-height: 1.2;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #d8a477;
      box-shadow: 0 0 0 3px rgba(181, 117, 66, 0.16);
    }

    button,
    .btn-link {
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff8f0;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-deep);
      border-color: var(--accent-deep);
    }

    .btn-ghost:hover,
    .btn-link:hover {
      background: #f5e6d5;
    }

    .summary-grid {
      padding: 12px 22px 22px;
      display: grid;
      grid-template-columns: 2.3fr 1fr;
      gap: 12px;
    }

    .safety-card {
      margin: 0 22px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff6ea;
      padding: 10px 12px;
      display: grid;
      gap: 8px;
    }

    .safety-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .safety-title {
      margin: 0;
      font-size: 0.86rem;
      color: var(--subtle);
    }

    .safety-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #5e4a3e;
    }

    .summary {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    }

    .stat {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #fff7ec;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--subtle);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .income {
      color: var(--income);
    }

    .expense {
      color: var(--expense);
    }

    .pie-box {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff7ec;
      padding: 10px;
      display: grid;
      justify-items: center;
      align-content: start;
      gap: 8px;
    }

    .pie-title {
      margin: 0;
      font-size: 0.86rem;
      color: var(--subtle);
    }

    .scope-switch {
      display: flex;
      gap: 6px;
      width: 100%;
      justify-content: center;
    }

    .scope-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .scope-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff8f0;
    }

    .pie-wrap {
      width: 136px;
      height: 136px;
      position: relative;
    }

    #expensePie {
      width: 136px;
      height: 136px;
    }

    .pie-empty {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: 0.8rem;
      color: var(--subtle);
      text-align: center;
      padding: 24px;
    }

    .pie-legend {
      width: 100%;
      display: grid;
      gap: 5px;
      font-size: 0.8rem;
      color: var(--subtle);
    }

    .income-analysis {
      width: 100%;
      margin-top: 4px;
      border-top: 1px dashed var(--line);
      padding-top: 8px;
      display: grid;
      gap: 6px;
    }

    .income-analysis-title {
      margin: 0;
      font-size: 0.8rem;
      color: var(--subtle);
      font-weight: 700;
    }

    .income-analysis-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #6b5649;
      gap: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .legend-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      flex: 0 0 auto;
    }

    .legend-left {
      display: inline-flex;
      align-items: center;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .form {
      padding: 0 22px 22px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, 1fr);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .field label {
      font-size: 0.82rem;
      color: var(--subtle);
    }

    .type-switch {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .type-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff8f0;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--subtle);
      min-height: 18px;
    }

    .input-with-btn {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    .btn-inline {
      padding: 10px 12px;
      font-size: 0.86rem;
      white-space: nowrap;
    }

    .btn-inline.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff8f0;
    }

    .split-panel {
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.5);
      display: grid;
      gap: 10px;
    }

    .split-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(140px, 1fr));
      gap: 10px;
    }

    .split-hint {
      margin: 0;
      color: var(--subtle);
      font-size: 0.83rem;
      min-height: 16px;
    }

    .project-manager {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.55);
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .asset-panel {
      margin: 0 22px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff7ec;
      padding: 10px 12px;
      display: grid;
      gap: 10px;
    }

    .asset-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .asset-title {
      margin: 0;
      font-size: 0.9rem;
      color: var(--subtle);
      font-weight: 700;
    }

    .asset-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #5e4a3e;
    }

    .project-manager-toggle {
      justify-self: start;
    }

    .project-manager-title {
      margin: 0;
      font-size: 0.92rem;
      color: #725748;
      font-weight: 700;
    }

    .project-form-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: 1.4fr 0.7fr 2fr auto;
    }

    .project-list {
      display: grid;
      gap: 8px;
    }

    .project-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fffaf4;
      padding: 8px 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
      font-size: 0.86rem;
    }

    .project-item.dragging {
      opacity: 0.5;
    }

    .project-item.drag-over {
      box-shadow: inset 0 0 0 2px rgba(181, 117, 66, 0.24);
      background: #f8eedf;
    }

    .project-view {
      display: inline-flex;
      align-items: center;
      gap: 7px;
    }

    .drag-handle {
      display: inline-block;
      color: #9c7f6e;
      user-select: none;
      cursor: grab;
      font-size: 0.95rem;
      line-height: 1;
    }

    .project-item-actions {
      display: inline-flex;
      gap: 6px;
    }

    .project-inline-grid {
      display: grid;
      grid-template-columns: 1.4fr 0.6fr 2fr;
      gap: 6px;
      align-items: center;
    }

    .project-inline-grid input {
      padding: 6px 8px;
      font-size: 0.82rem;
    }

    .tiny-btn {
      font-size: 0.8rem;
      padding: 6px 8px;
    }

    .col-2 { grid-column: span 2; }
    .col-3 { grid-column: span 3; }
    .col-12 { grid-column: span 12; }

    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .list-wrap {
      padding: 0 22px 22px;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }

    .list-header h2 {
      margin: 0;
      font-size: 1rem;
    }

    .list-count {
      color: var(--subtle);
      font-size: 0.84rem;
    }

    .records {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      background: #fffaf4;
    }

    .records th,
    .records td {
      padding: 11px 10px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: middle;
      font-size: 0.91rem;
    }

    .records thead th {
      background: #f7e6d0;
      color: #6f4d3a;
      font-weight: 700;
    }

    .records tbody tr:last-child td {
      border-bottom: none;
    }

    .empty {
      text-align: center;
      padding: 14px;
      color: var(--subtle);
    }

    .tag {
      display: inline-block;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.79rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .tag-income {
      color: #526d45;
      background: rgba(141, 169, 119, 0.2);
    }

    .tag-expense {
      color: #975344;
      background: rgba(205, 139, 121, 0.22);
    }

    .tag-category {
      color: #7b5f50;
      background: #f1dfc8;
      font-weight: 600;
    }

    .tag-support {
      color: #8a4c2a;
      background: rgba(255, 201, 143, 0.38);
      border: 1px solid rgba(221, 147, 87, 0.45);
      font-weight: 700;
    }

    .tag-project {
      color: #4e6d8e;
      background: rgba(191, 224, 255, 0.68);
      border: 1px solid rgba(116, 169, 224, 0.35);
      font-weight: 600;
    }

    .project-row {
      background: linear-gradient(120deg, rgba(210, 235, 255, 0.36), rgba(220, 243, 255, 0.2));
      backdrop-filter: blur(4px);
    }

    .records tr.editing-row {
      outline: 2px solid rgba(181, 117, 66, 0.45);
      outline-offset: -2px;
      box-shadow: 0 0 0 3px rgba(181, 117, 66, 0.12);
    }

    .item-wrap {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      flex-wrap: wrap;
    }

    .btn-delete {
      border-color: #e3c8c2;
      color: var(--danger);
      background: #fff2f0;
      border-radius: 8px;
      padding: 6px 9px;
      font-size: 0.82rem;
    }

    .btn-delete:hover {
      background: #ffe6e1;
    }

    .btn-edit {
      border-color: #d7c5b5;
      color: #6f4d3a;
      background: #fff7ed;
      border-radius: 8px;
      padding: 6px 9px;
      font-size: 0.82rem;
    }

    .btn-edit:hover {
      background: #f5e6d5;
    }

    input[type="date"] {
      width: 100%;
      max-width: 100%;
      min-width: 0;
    }

    .robot-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 62px;
      height: 62px;
      border-radius: 50%;
      border: 1px solid #e3c2a3;
      background: linear-gradient(145deg, #f6dec1, #f0c899);
      box-shadow: 0 8px 18px rgba(129, 81, 46, 0.25);
      font-size: 1.5rem;
      z-index: 30;
    }

    .robot-panel {
      position: fixed;
      right: 18px;
      bottom: 92px;
      width: min(360px, calc(100vw - 24px));
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #fff8ef;
      box-shadow: var(--shadow);
      padding: 12px;
      z-index: 30;
      display: none;
    }

    .robot-panel.show {
      display: block;
    }

    .tool-title {
      margin: 0 0 8px;
      color: #6f4d3a;
      font-size: 0.93rem;
      font-weight: 700;
    }

    .tool-list {
      margin: 0 0 10px;
      padding-left: 18px;
      color: #7a6357;
      font-size: 0.86rem;
      line-height: 1.55;
    }

    .tool-switch {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tool-switch button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff8f0;
    }

    .tool-body {
      display: none;
    }

    .tool-body.show {
      display: block;
    }

    .leaf-board-wrap {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 8px;
      background: #faf2e5;
    }

    .leaf-board {
      position: relative;
      width: 100%;
      height: 170px;
      border-radius: 10px;
      overflow: hidden;
      background:
        radial-gradient(circle at 25% 65%, rgba(194, 221, 162, 0.55) 0 18%, transparent 19%),
        radial-gradient(circle at 70% 35%, rgba(168, 206, 133, 0.56) 0 22%, transparent 23%),
        radial-gradient(circle at 60% 75%, rgba(209, 232, 184, 0.55) 0 17%, transparent 18%),
        linear-gradient(135deg, #f4f8e9, #eaf4db);
    }

    .leaf-canvas {
      position: absolute;
      inset: 0;
      touch-action: none;
    }

    .leaf-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .calc {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fbf1e3;
    }

    .calc-screen {
      width: 100%;
      margin-bottom: 8px;
      text-align: right;
      font-weight: 700;
      font-size: 1rem;
      background: #fff8f0;
    }

    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .calc-grid button {
      padding: 9px 0;
      font-weight: 700;
    }

    .sync-status {
      font-size: 0.8rem;
      color: var(--subtle);
      align-self: center;
    }
    .sync-status.online { color: var(--income); }
    .sync-status.offline { color: var(--expense); }

    .sync-config-panel {
      padding: 16px 22px;
    }
    .sync-config-title {
      margin: 0 0 12px;
      font-size: 0.95rem;
      color: var(--text);
      font-weight: 700;
    }
    .sync-config-fields {
      display: grid;
      gap: 12px;
      margin-bottom: 10px;
    }
    .sync-config-hint {
      margin: 0;
      font-size: 0.82rem;
      color: var(--subtle);
    }

    .install-banner {
      width: 100%;
      max-width: 1080px;
      margin: 0 auto 10px;
      padding: 0 16px;
      position: relative;
      z-index: 2;
      display: none;
    }

    .install-banner.show {
      display: block;
    }

    .install-banner-inner {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff7ec;
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 0.84rem;
      color: #6d574a;
    }

    .install-banner-actions {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(78px + env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(10px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 40;
      background: rgba(70, 54, 45, 0.94);
      color: #fffaf4;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 0.82rem;
      white-space: nowrap;
      max-width: calc(100vw - 20px);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    body.standalone .install-banner {
      display: none !important;
    }

    @media (max-width: 860px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }

      .pie-box {
        justify-items: start;
      }
    }

    @media (max-width: 760px) {
      .form {
        grid-template-columns: repeat(2, 1fr);
      }

      .col-2,
      .col-3,
      .actions {
        grid-column: span 2;
      }
    }

    @media (max-width: 600px) {
      body {
        padding:
          calc(8px + env(safe-area-inset-top))
          8px
          calc(62px + env(safe-area-inset-bottom));
      }

      .app {
        padding: 0 6px;
        gap: 10px;
      }

      .header {
        padding: 12px 12px 8px;
      }

      h1 {
        font-size: 1.2rem;
      }

      .subtitle {
        margin-top: 4px;
        font-size: 0.8rem;
      }

      .actions,
      .header-right,
      .scope-switch,
      .tool-switch {
        flex-direction: column;
        align-items: stretch;
      }

      .summary-grid,
      .form,
      .list-wrap,
      .asset-panel {
        padding-left: 12px;
        padding-right: 12px;
      }

      .summary-grid {
        gap: 8px;
      }

      .summary {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }

      .summary .stat:nth-child(n + 5) {
        display: none;
      }

      .stat {
        padding: 8px 10px;
      }

      .stat-label {
        font-size: 0.75rem;
        margin-bottom: 2px;
      }

      .stat-value {
        font-size: 1rem;
      }

      .form {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .col-2,
      .col-3,
      .actions {
        grid-column: span 1;
      }

      .field {
        gap: 4px;
      }

      .field label {
        margin-bottom: 2px;
      }

      .type-switch {
        margin-top: 4px;
        gap: 10px;
      }

      .type-switch button {
        min-height: 48px;
      }

      .input-with-btn {
        grid-template-columns: 1fr;
      }

      .records {
        border: none;
        background: transparent;
      }

      .records thead {
        display: none;
      }

      .records tbody {
        display: grid;
        gap: 10px;
      }

      .records tr {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-areas:
          "date amount"
          "item item"
          "actions actions";
        row-gap: 6px;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        background: #fffaf4;
      }

      .records td {
        border-bottom: none;
        padding: 0;
      }

      .records td.cell-date {
        grid-area: date;
        font-size: 0.8rem;
        color: var(--subtle);
      }

      .records td.cell-type,
      .records td.cell-note {
        display: none;
      }

      .records td.cell-item {
        grid-area: item;
        font-size: 0.9rem;
      }

      .records td.cell-item .item-wrap {
        display: grid;
        gap: 6px;
      }

      .records td.cell-amount {
        grid-area: amount;
        justify-self: end;
        font-size: 1.02rem;
        font-weight: 800;
      }

      .records td.cell-actions {
        grid-area: actions;
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        flex-wrap: wrap;
      }

      .records td.empty {
        display: block;
        text-align: center;
        padding: 8px 0;
      }

      .records td.empty::before {
        content: "";
        display: none;
      }

      .robot-btn {
        width: 54px;
        height: 54px;
        right: 12px;
        bottom: calc(12px + env(safe-area-inset-bottom));
      }
    }

    @media (max-width: 500px) {
      body {
        padding:
          calc(8px + env(safe-area-inset-top))
          8px
          calc(112px + env(safe-area-inset-bottom));
        font-size: 15px;
      }

      .app {
        padding: 0 4px;
        gap: 8px;
      }

      .header {
        align-items: flex-start;
      }

      .header-right {
        margin-left: auto;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: center;
        gap: 6px;
      }

      .header-right .btn-link {
        min-height: 34px;
        padding: 6px 8px;
        font-size: 0.76rem;
        border-radius: 8px;
        white-space: nowrap;
      }

      #syncStatus {
        font-size: 0.72rem;
        white-space: nowrap;
      }

      .header,
      .summary-grid,
      .form,
      .list-wrap,
      .sync-config-panel,
      .asset-panel {
        padding-left: 8px;
        padding-right: 8px;
      }

      .summary {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
      }

      .summary .stat:nth-child(n + 5) {
        display: block;
      }

      .stat {
        min-width: 0;
        padding: 8px;
      }

      .stat-value {
        font-size: 0.96rem;
        line-height: 1.25;
        overflow-wrap: anywhere;
      }

      .form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .field,
      .actions,
      .field input,
      .field select {
        width: 100%;
      }

      .field input,
      .field select,
      .field button,
      .btn-link,
      button {
        min-height: 48px;
      }

      .header-right .btn-link {
        min-height: 34px;
      }

      #date {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        font-size: 0.9rem;
      }

      .type-switch {
        width: 100%;
        margin-top: 4px;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .type-switch button {
        width: 100%;
        min-height: 50px;
      }

      .records {
        border: none;
        background: transparent;
      }

      .records thead {
        display: none;
      }

      .records tbody {
        display: grid;
        gap: 8px;
      }

      .records tr {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        grid-template-areas:
          "item amount"
          "item amount"
          "date date"
          "actions actions";
        row-gap: 6px;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 10px;
        background: #fffaf4;
      }

      .records td {
        border-bottom: none;
        padding: 0;
        min-width: 0;
      }

      .records td.cell-type,
      .records td.cell-note {
        display: none;
      }

      .records td.cell-item {
        grid-area: item;
      }

      .records td.cell-item .item-wrap {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .records td.cell-item .item-wrap > span:first-child {
        order: 2;
        font-size: 0.96rem;
        font-weight: 600;
      }

      .records td.cell-item .item-wrap .tag-category {
        order: 1;
      }

      .records td.cell-item .item-wrap .tag:not(.tag-category) {
        order: 3;
      }

      .records td.cell-amount {
        grid-area: amount;
        justify-self: end;
        align-self: start;
        font-size: 1.05rem;
        font-weight: 800;
      }

      .records td.cell-date {
        grid-area: date;
        font-size: 0.78rem;
        color: var(--subtle);
      }

      .records td.cell-actions {
        grid-area: actions;
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        flex-wrap: wrap;
      }

      .records td.empty {
        display: block;
        text-align: center;
        padding: 10px 4px;
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        position: static;
      }

      .actions button {
        width: 100%;
      }

      .actions .btn-ghost,
      .actions .btn-primary {
        min-height: 54px;
        font-size: 1rem;
        font-weight: 700;
      }

      .robot-btn {
        width: 50px;
        height: 50px;
        right: 10px;
        bottom: calc(10px + env(safe-area-inset-bottom));
      }

      .robot-panel {
        width: min(340px, calc(100vw - 16px));
        right: 8px;
        bottom: calc(68px + env(safe-area-inset-bottom));
        max-height: 60vh;
        overflow: auto;
      }

      .toast {
        bottom: calc(70px + env(safe-area-inset-bottom));
        font-size: 0.78rem;
      }
    }

    @media (max-width: 390px) {
      body {
        padding:
          calc(8px + env(safe-area-inset-top))
          8px
          calc(126px + env(safe-area-inset-bottom));
        font-size: 14px;
      }

      .header {
        padding-top: 10px;
        padding-bottom: 6px;
      }

      h1 {
        font-size: 1.06rem;
      }

      .subtitle {
        font-size: 0.76rem;
      }

      .summary {
        grid-template-columns: 1fr;
      }

      .pie-wrap,
      #expensePie {
        width: 120px;
        height: 120px;
      }

      .records tr {
        padding: 9px;
        gap: 5px;
      }

      .records td.cell-amount {
        font-size: 1rem;
      }

      .actions {
        gap: 8px;
        margin-bottom: 4px;
      }

      .actions .btn-ghost,
      .actions .btn-primary {
        min-height: 52px;
        font-size: 0.96rem;
      }

      .robot-btn {
        width: 46px;
        height: 46px;
        right: 8px;
      }

      .robot-panel {
        width: calc(100vw - 12px);
        right: 6px;
        bottom: calc(60px + env(safe-area-inset-bottom));
      }

      .header-right .btn-link {
        min-height: 32px;
        padding: 5px 7px;
        font-size: 0.72rem;
      }

      .toast {
        bottom: calc(64px + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
  <div id="installBanner" class="install-banner" aria-live="polite">
    <div class="install-banner-inner">
      <span id="installText">å®‰è£åˆ°ä¸»ç•«é¢å¯åƒ App ä¸€æ¨£é–‹å•Ÿï¼ˆç„¡ç¶²å€åˆ—ï¼‰ã€‚</span>
      <div class="install-banner-actions">
        <button id="installBtn" type="button" class="btn-primary" hidden>å®‰è£ App</button>
        <button id="dismissInstallBtn" type="button" class="btn-ghost">ç¨å¾Œ</button>
      </div>
    </div>
  </div>
  <main class="app">
    <section class="card">
      <div class="header">
        <div>
          <h1>æš–æš–è¨˜å¸³ App</h1>
          <p class="subtitle">å¤§åœ°è‰²ç³»ã€èŠ±åœ’æ°›åœï¼Œè¨˜ä¸‹æ¯ä¸€ç­†ç”Ÿæ´»æ”¶æ”¯</p>
        </div>
        <div class="header-right">
          <span id="syncStatus" class="sync-status" title="é›²ç«¯åŒæ­¥ç‹€æ…‹"></span>
          <button type="button" id="syncConfigToggle" class="btn-link">é›²ç«¯åŒæ­¥è¨­å®š</button>
          <a class="btn-link" href="categories.html">ç®¡ç†é¡åˆ¥</a>
        </div>
      </div>

      <div id="syncConfigPanel" class="sync-config-panel card" hidden>
        <p class="sync-config-title">Supabase é›²ç«¯åŒæ­¥ï¼ˆé›»è…¦èˆ‡æ‰‹æ©Ÿå…±ç”¨åŒä¸€ä»½è³‡æ–™ï¼‰</p>
        <div class="sync-config-fields">
          <div class="field">
            <label for="supabaseUrl">Supabase å°ˆæ¡ˆ URL</label>
            <input id="supabaseUrl" type="url" placeholder="https://xxxxx.supabase.co" />
          </div>
          <div class="field">
            <label for="supabaseAnonKey">Anon Keyï¼ˆå…¬é–‹é‡‘é‘°ï¼‰</label>
            <input id="supabaseAnonKey" type="text" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6..." autocomplete="off" />
          </div>
          <button type="button" id="saveSupabaseConfig" class="btn-primary">å„²å­˜è¨­å®š</button>
        </div>
        <p class="sync-config-hint">é›¢ç·šæ™‚æœƒå…ˆå­˜æ–¼æœ¬æ©Ÿï¼Œæœ‰ç¶²è·¯æ™‚æœƒè‡ªå‹•ä¸Šå‚³ä¸¦æ‹‰å–æœ€æ–°è³‡æ–™ã€‚å¤šè£ç½®ä»¥æœ€å¾ŒåŒæ­¥çš„ç‚ºæº–ã€‚</p>
      </div>

      <div class="safety-card">
        <div class="safety-head">
          <p class="safety-title">æœ¬æœˆå¯ç”¨é¤˜é¡</p>
          <span id="monthAvailableValue" class="safety-value">$0</span>
        </div>
      </div>

      <div class="asset-panel">
        <div class="asset-head">
          <p id="assetReportTitle" class="asset-title">å¸³æˆ¶ç¸½é‡‘é¡</p>
          <span id="assetReportValue" class="asset-value">$0</span>
        </div>
        <a class="btn-link" href="accounts.html">å‰å¾€è³‡ç”¢è¨­å®š</a>
      </div>

      <div class="summary-grid">
        <div class="summary">
          <div class="stat">
            <div class="stat-label">ç›®å‰çµé¤˜</div>
            <div id="balance" class="stat-value">$0</div>
          </div>
          <div class="stat">
            <div class="stat-label">ç¸½æ”¶å…¥</div>
            <div id="totalIncome" class="stat-value income">$0</div>
          </div>
          <div class="stat">
            <div class="stat-label">ç¸½æ”¯å‡º</div>
            <div id="totalExpense" class="stat-value expense">$0</div>
          </div>
          <div class="stat">
            <div class="stat-label">æœ¬æœˆæ”¶å…¥ç´¯è¨ˆ</div>
            <div id="monthIncome" class="stat-value income">$0</div>
          </div>
          <div class="stat">
            <div class="stat-label">ç•¶å¹´åº¦æ”¶å…¥ç´¯è¨ˆ</div>
            <div id="yearIncome" class="stat-value income">$0</div>
          </div>
        </div>
        <div class="pie-box">
          <p id="pieTitle" class="pie-title">æœ¬æœˆæ¶ˆè²»åˆ†é¡å æ¯”</p>
          <div class="scope-switch">
            <button id="pieMonthBtn" type="button" class="scope-btn active">æœ¬æœˆ</button>
            <button id="pieYearBtn" type="button" class="scope-btn">ç•¶å¹´åº¦</button>
          </div>
          <div class="pie-wrap">
            <canvas id="expensePie" width="136" height="136"></canvas>
            <div id="pieEmpty" class="pie-empty">å°šç„¡æ”¯å‡ºè³‡æ–™</div>
          </div>
          <div id="pieLegend" class="pie-legend"></div>
          <div id="incomeAnalysis" class="income-analysis">
            <p class="income-analysis-title">æ”¶å…¥åˆ†æï¼ˆæœ¬æœŸï¼‰</p>
            <div class="income-analysis-item"><span>å›ºå®šè–ªè³‡</span><span id="salaryIncomeValue">$0</span></div>
            <div class="income-analysis-item"><span>è£œå„Ÿæ€§æ”¯æ´</span><span id="supportIncomeValue">$0</span></div>
          </div>
        </div>
      </div>

      <form id="recordForm" class="form">
        <div class="field col-2">
          <label for="date">æ—¥æœŸ</label>
          <input id="date" name="date" type="date" required />
        </div>

        <div class="field col-2">
          <label for="type">é¡å‹</label>
          <input id="type" name="type" type="hidden" value="income" />
          <div class="type-switch">
            <button id="typeIncomeBtn" type="button" class="type-btn active">æ”¶å…¥</button>
            <button id="typeExpenseBtn" type="button" class="type-btn">æ”¯å‡º</button>
          </div>
        </div>

        <div class="field col-3">
          <label for="itemName">é …ç›®åç¨±</label>
          <input id="itemName" name="itemName" type="text" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è¨ˆç¨‹è»Šã€é‹å­" required />
          <span id="autoClassifyHint" class="hint"></span>
        </div>

        <div class="field col-2">
          <label for="category">åˆ†é¡</label>
          <select id="category" name="category" required></select>
        </div>

        <div class="field col-2">
          <label for="project">å°ˆæ¡ˆ</label>
          <select id="project" name="project"></select>
        </div>

        <div class="field col-2">
          <label for="recordAccount">å¸³æˆ¶</label>
          <select id="recordAccount" name="recordAccount" required></select>
        </div>

        <div class="field col-2">
          <label for="amount">é‡‘é¡</label>
          <div class="input-with-btn">
            <input id="amount" name="amount" type="number" min="1" step="1" placeholder="0" required />
            <button type="button" id="splitToggleBtn" class="btn-inline">æ‹†åˆ†</button>
          </div>
        </div>

        <div class="field col-3">
          <label for="note">å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
          <input id="note" name="note" type="text" placeholder="ç°¡çŸ­èªªæ˜" />
        </div>

        <div id="splitPanel" class="split-panel col-12" hidden>
          <div class="split-grid">
            <div class="field">
              <label for="myShare">æˆ‘çš„éƒ¨åˆ†</label>
              <input id="myShare" type="number" min="0" step="1" placeholder="0" readonly />
            </div>
            <div class="field">
              <label for="susieShare">Susie çš„éƒ¨åˆ†</label>
              <input id="susieShare" type="number" min="0" step="1" placeholder="0" />
            </div>
          </div>
          <p id="splitHint" class="split-hint"></p>
        </div>

        <div class="field col-12">
          <button type="button" id="projectManagerToggleBtn" class="btn-inline project-manager-toggle">å±•é–‹å°ˆæ¡ˆç®¡ç†</button>
          <div id="projectManagerPanel" class="project-manager" hidden>
            <p class="project-manager-title">å°ˆæ¡ˆç®¡ç†ï¼ˆå¯æ–°å¢ / ä¿®æ”¹ / åˆªé™¤ï¼‰</p>
            <div class="project-form-grid">
              <input id="projectNameInput" type="text" placeholder="å°ˆæ¡ˆåç¨±" />
              <input id="projectIconInput" type="text" placeholder="åœ–ç¤º" />
              <input id="projectKeywordsInput" type="text" placeholder="é—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰" />
              <button type="button" id="addProjectBtn" class="btn-inline">æ–°å¢å°ˆæ¡ˆ</button>
            </div>
            <div id="projectList" class="project-list"></div>
          </div>
        </div>

        <div class="actions col-12">
          <button type="reset" class="btn-ghost">æ¸…ç©º</button>
          <button type="submit" class="btn-primary">æ–°å¢ç´€éŒ„</button>
        </div>
      </form>

      <div class="list-wrap">
        <div class="list-header">
          <h2>äº¤æ˜“æ˜ç´°</h2>
          <span id="recordCount" class="list-count">0 ç­†ç´€éŒ„</span>
        </div>

        <table class="records">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>é¡å‹</th>
              <th>é …ç›® / é¡åˆ¥</th>
              <th>å‚™è¨»</th>
              <th>é‡‘é¡</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="recordBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <button id="robotBtn" class="robot-btn" title="é–‹å•Ÿå°å¹«æ‰‹">ğŸ¤–</button>
  <div id="appToast" class="toast" role="status" aria-live="polite"></div>
  <aside id="robotPanel" class="robot-panel" aria-hidden="true">
    <p class="tool-title">å°å¹«æ‰‹å·¥å…·ç®±</p>
    <ol class="tool-list">
      <li>è¢å…‰ç­†å¯ç›´æ¥åœ¨è‘‰é¢ä¸Šå¡—å¯«</li>
      <li>è¨ˆç®—æ©Ÿï¼Œç›´æ¥åœ¨é é¢æ—å”åŠ©ä½ åšç°¡å–®è¨ˆç®—</li>
    </ol>
    <div class="tool-switch">
      <button type="button" id="showHighlighter" class="active">è¢å…‰ç­†</button>
      <button type="button" id="showCalculator">è¨ˆç®—æ©Ÿ</button>
    </div>

    <section id="toolHighlighter" class="tool-body show">
      <div class="leaf-board-wrap">
        <div class="leaf-board">
          <canvas id="leafCanvas" class="leaf-canvas"></canvas>
        </div>
      </div>
      <div class="leaf-actions">
        <button type="button" id="clearLeaf">æ¸…ç©ºè‘‰é¢</button>
      </div>
    </section>

    <section id="toolCalculator" class="tool-body">
      <div class="calc">
        <input id="calcScreen" class="calc-screen" type="text" value="0" readonly />
        <div class="calc-grid" id="calcGrid">
          <button type="button" data-action="clear">C</button>
          <button type="button" data-action="delete">DEL</button>
          <button type="button" data-value="%">%</button>
          <button type="button" data-value="/">/</button>
          <button type="button" data-value="7">7</button>
          <button type="button" data-value="8">8</button>
          <button type="button" data-value="9">9</button>
          <button type="button" data-value="*">*</button>
          <button type="button" data-value="4">4</button>
          <button type="button" data-value="5">5</button>
          <button type="button" data-value="6">6</button>
          <button type="button" data-value="-">-</button>
          <button type="button" data-value="1">1</button>
          <button type="button" data-value="2">2</button>
          <button type="button" data-value="3">3</button>
          <button type="button" data-value="+">+</button>
          <button type="button" data-value="0">0</button>
          <button type="button" data-value=".">.</button>
          <button type="button" data-action="equal" style="grid-column: span 2;">=</button>
        </div>
      </div>
    </section>
  </aside>

  <script>
    const RECORD_STORAGE_KEY = "money-app-records-v1";
    const CATEGORY_STORAGE_KEY = "money-app-categories-v1";
    const PROJECT_STORAGE_KEY = "money-app-projects-v1";
    const ACCOUNT_STORAGE_KEY = "money-app-accounts-v1";
    const LAST_LOCAL_DATA_UPDATE_KEY = "money-app-last-local-data-update-at";
    const SUPABASE_URL_KEY = "money-app-supabase-url";
    const SUPABASE_ANON_KEY = "money-app-supabase-anon-key";
    const SUPABASE_DEFAULT_URL = "https://wbirxxapsemulrsjjqao.supabase.co";
    const SUPABASE_DEFAULT_ANON_KEY = "sb_publishable_toooZNwiSeEG6YAHD9qrZA_0GA7xNYi";
    const SYNC_TABLE = "money_sync_state";
    const SYNC_ROW_ID = "main";
    const SYNC_KEY_COLUMN = "sync_key";
    const SYNC_PAYLOAD_COLUMN = "sync_payload";
    const SYNC_UPDATED_AT_COLUMN = "sync_updated_at";
    const SUPPORT_INCOME_CATEGORY = "å¤–éƒ¨æ”¯æ´ (è€å…¬)";
    const RECORD_KIND_INITIAL_BALANCE = "INITIAL_BALANCE";
    const INCOME_CATEGORIES = ["å›ºå®šè–ªè³‡", SUPPORT_INCOME_CATEGORY, "å…¶ä»–æ”¶å…¥"];
    const DEFAULT_CATEGORIES = [
      { name: "é£Ÿ", keywords: ["åˆé¤", "æ—©é¤", "æ™šé¤", "ç«é‹", "é£²æ–™", "å’–å•¡", "ä¾¿ç•¶"] },
      { name: "è¡Œ", keywords: ["å…¬è»Š", "æ·é‹", "åŠ æ²¹", "è¨ˆç¨‹è»Š", "åœè»Š", "é«˜éµ", "ç«è»Š"] },
      { name: "è¡£", keywords: ["è¡£æœ", "é‹å­", "å¤–å¥—", "è¤²å­", "å¸½å­", "é…ä»¶"] },
      { name: "ä½", keywords: ["æˆ¿ç§Ÿ", "æ°´è²»", "é›»è²»", "ç“¦æ–¯", "ç¶²è·¯"] },
      { name: "è‚²æ¨‚", keywords: ["é›»å½±", "èª²ç¨‹", "æ›¸ç±", "éŠæˆ²", "æ—…è¡Œ"] }
    ];
    const PIE_COLORS = ["#d58a61", "#8ea96f", "#d7a84a", "#c97b6b", "#8e6ea6", "#80a7b2", "#b08866"];
    const DEFAULT_PROJECTS = [
      { id: "none", name: "ä¸€èˆ¬", icon: "ğŸ§¾", keywords: [] },
      { id: "renovation-2026", name: "2026 æˆ¿å±‹è£æ½¢", icon: "ğŸ ", keywords: ["ç£ç£š", "æ²™ç™¼", "è£æ½¢"] },
      { id: "travel-events", name: "æ—…éŠèˆ‡æ´»å‹•", icon: "âœˆï¸", keywords: ["æ—…éŠ", "æ´»å‹•", "æ©Ÿç¥¨"] },
      { id: "investment-fund", name: "æŠ•è³‡æ’¥æ¬¾", icon: "ğŸ“ˆ", keywords: ["æŠ•è³‡", "æ’¥æ¬¾"] },
      { id: "susie-only", name: "Susie å°ˆå±¬", icon: "ğŸ‘§", keywords: ["å­¸è²»", "æ›¸åŒ…", "è£œç¿’"] },
      { id: "hobby-chicken", name: "èˆˆè¶£é¤Šé›", icon: "ğŸ”", keywords: ["é›èˆ", "é£¼æ–™"] }
    ];
    const DEFAULT_ACCOUNTS = [
      { id: "acc-cash", name: "ç¾é‡‘", assetType: "liquid", currentAmount: 0 },
      { id: "acc-bank", name: "æ´»å­˜", assetType: "liquid", currentAmount: 0 },
      { id: "acc-fund", name: "åŸºé‡‘", assetType: "long_term", currentAmount: 0 }
    ];

    const form = document.getElementById("recordForm");
    const formSubmitBtn = form ? form.querySelector('button[type="submit"]') : null;
    const formResetBtn = form ? form.querySelector('button[type="reset"]') : null;
    const dateInput = document.getElementById("date");
    const typeInput = document.getElementById("type");
    const itemNameInput = document.getElementById("itemName");
    const categorySelect = document.getElementById("category");
    const typeIncomeBtn = document.getElementById("typeIncomeBtn");
    const typeExpenseBtn = document.getElementById("typeExpenseBtn");
    const projectSelect = document.getElementById("project");
    const amountInput = document.getElementById("amount");
    const noteInput = document.getElementById("note");
    const autoClassifyHint = document.getElementById("autoClassifyHint");
    const splitToggleBtn = document.getElementById("splitToggleBtn");
    const splitPanel = document.getElementById("splitPanel");
    const myShareInput = document.getElementById("myShare");
    const susieShareInput = document.getElementById("susieShare");
    const splitHint = document.getElementById("splitHint");
    const projectNameInput = document.getElementById("projectNameInput");
    const projectIconInput = document.getElementById("projectIconInput");
    const projectKeywordsInput = document.getElementById("projectKeywordsInput");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const projectList = document.getElementById("projectList");
    const projectManagerPanel = document.getElementById("projectManagerPanel");
    const projectManagerToggleBtn = document.getElementById("projectManagerToggleBtn");
    const recordAccountSelect = document.getElementById("recordAccount");

    const balanceEl = document.getElementById("balance");
    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpenseEl = document.getElementById("totalExpense");
    const monthIncomeEl = document.getElementById("monthIncome");
    const yearIncomeEl = document.getElementById("yearIncome");
    const recordBody = document.getElementById("recordBody");
    const recordCountEl = document.getElementById("recordCount");
    const pieCanvas = document.getElementById("expensePie");
    const pieEmpty = document.getElementById("pieEmpty");
    const pieLegend = document.getElementById("pieLegend");
    const pieTitle = document.getElementById("pieTitle");
    const pieMonthBtn = document.getElementById("pieMonthBtn");
    const pieYearBtn = document.getElementById("pieYearBtn");
    const monthAvailableValueEl = document.getElementById("monthAvailableValue");
    const salaryIncomeValue = document.getElementById("salaryIncomeValue");
    const supportIncomeValue = document.getElementById("supportIncomeValue");
    const assetReportTitle = document.getElementById("assetReportTitle");
    const assetReportValue = document.getElementById("assetReportValue");

    const robotBtn = document.getElementById("robotBtn");
    const robotPanel = document.getElementById("robotPanel");
    const showHighlighter = document.getElementById("showHighlighter");
    const showCalculator = document.getElementById("showCalculator");
    const toolHighlighter = document.getElementById("toolHighlighter");
    const toolCalculator = document.getElementById("toolCalculator");
    const leafCanvas = document.getElementById("leafCanvas");
    const clearLeaf = document.getElementById("clearLeaf");
    const calcScreen = document.getElementById("calcScreen");
    const calcGrid = document.getElementById("calcGrid");
    const appToast = document.getElementById("appToast");

    const currency = new Intl.NumberFormat("zh-TW", {
      style: "currency",
      currency: "TWD",
      maximumFractionDigits: 0
    });

    let records = [];
    let categories = [];
    let projects = [];
    let accounts = [];
    let calcExpression = "0";
    let drawing = false;
    let lastPoint = { x: 0, y: 0 };
    let pieScope = "month";
    let splitEnabled = false;
    let editingRecordId = null;
    let editingProjectId = null;
    let draggingProjectId = null;
    let toastTimer = null;

    function markLocalDataUpdated() {
      localStorage.setItem(LAST_LOCAL_DATA_UPDATE_KEY, new Date().toISOString());
    }

    function setTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    function normalizeCategories(input) {
      if (!Array.isArray(input) || input.length === 0) return DEFAULT_CATEGORIES;
      const cleaned = input
        .map((item) => {
          if (!item || typeof item.name !== "string") return null;
          const name = item.name.trim();
          if (!name) return null;
          const keywords = Array.isArray(item.keywords)
            ? item.keywords.map((w) => String(w || "").trim()).filter(Boolean)
            : [];
          return { name, keywords };
        })
        .filter(Boolean);
      return cleaned.length ? cleaned : DEFAULT_CATEGORIES;
    }

    function loadCategories() {
      try {
        const raw = localStorage.getItem(CATEGORY_STORAGE_KEY);
        categories = normalizeCategories(raw ? JSON.parse(raw) : null);
      } catch {
        categories = normalizeCategories(null);
      }
      localStorage.setItem(CATEGORY_STORAGE_KEY, JSON.stringify(categories));
    }

    function renderCategoryOptions() {
      const selected = categorySelect.value;
      categorySelect.innerHTML = "";
      const source = typeInput.value === "income" ? INCOME_CATEGORIES : categories.map((category) => category.name);
      source.forEach((categoryName, index) => {
        const option = document.createElement("option");
        option.value = categoryName;
        option.textContent = categoryName;
        categorySelect.appendChild(option);
        if (index === 0) categorySelect.value = categoryName;
      });
      if (selected && source.includes(selected)) {
        categorySelect.value = selected;
      } else if (source.length) {
        categorySelect.value = source[0];
      }
    }

    function setType(nextType) {
      typeInput.value = nextType === "expense" ? "expense" : "income";
      const isIncome = typeInput.value === "income";
      typeIncomeBtn.classList.toggle("active", isIncome);
      typeExpenseBtn.classList.toggle("active", !isIncome);

      // æ‹†åˆ†åƒ…åœ¨æ”¯å‡ºæ¨¡å¼é–‹æ”¾ï¼Œé¿å…æ”¶å…¥å ´æ™¯èª¤ç”¨
      splitToggleBtn.disabled = isIncome;
      if (isIncome) {
        setSplitEnabled(false);
      }
      renderCategoryOptions();
    }

    function showToast(message) {
      if (!appToast) return;
      appToast.textContent = String(message || "");
      appToast.classList.add("show");
      if (toastTimer) {
        clearTimeout(toastTimer);
      }
      toastTimer = setTimeout(() => {
        appToast.classList.remove("show");
      }, 1600);
    }

    function setFormEditMode(editing) {
      if (formSubmitBtn) {
        formSubmitBtn.textContent = editing ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢ç´€éŒ„";
      }
      if (formResetBtn) {
        formResetBtn.textContent = editing ? "å–æ¶ˆä¿®æ”¹" : "æ¸…ç©º";
      }
    }

    function beginEditRecord(recordId) {
      const target = records.find((record) => record.id === recordId);
      if (!target) return;

      editingRecordId = recordId;
      setFormEditMode(true);

      setType(target.type);
      dateInput.value = String(target.date || "");
      itemNameInput.value = String(target.itemName || "");
      amountInput.value = Number.isFinite(Number(target.amount)) ? String(Number(target.amount)) : "";
      noteInput.value = String(target.note || "");

      renderCategoryOptions();
      if (target.category && Array.from(categorySelect.options).some((option) => option.value === target.category)) {
        categorySelect.value = target.category;
      }
      if (recordAccountSelect) {
        if (target.accountId && Array.from(recordAccountSelect.options).some((option) => option.value === target.accountId)) {
          recordAccountSelect.value = target.accountId;
        } else if (recordAccountSelect.options.length > 0) {
          recordAccountSelect.value = recordAccountSelect.options[0].value;
        }
      }

      renderProjectOptions();
      if (target.projectId && Array.from(projectSelect.options).some((option) => option.value === target.projectId)) {
        projectSelect.value = target.projectId;
      } else {
        projectSelect.value = "none";
      }

      const hasSplit = Number.isFinite(Number(target.myShare)) && Number.isFinite(Number(target.susieShare));
      setSplitEnabled(target.type === "expense" && hasSplit);
      if (splitEnabled) {
        susieShareInput.value = String(Number(target.susieShare) || 0);
        refreshSplitHint();
      }

      autoClassifyHint.textContent = "æ­£åœ¨ä¿®æ”¹ç´€éŒ„";
      renderRecords();
      form.scrollIntoView({ behavior: "smooth", block: "start" });
      itemNameInput.focus();
    }

    function exitEditMode(shouldRender = true) {
      editingRecordId = null;
      setFormEditMode(false);
      autoClassifyHint.textContent = "";
      if (shouldRender) {
        renderRecords();
      }
    }

    function setProjectManagerOpen(open) {
      if (!projectManagerPanel || !projectManagerToggleBtn) return;
      projectManagerPanel.hidden = !open;
      projectManagerPanel.style.display = open ? "grid" : "none";
      projectManagerToggleBtn.textContent = open ? "æ”¶èµ·å°ˆæ¡ˆç®¡ç†" : "å±•é–‹å°ˆæ¡ˆç®¡ç†";
      projectManagerToggleBtn.setAttribute("aria-expanded", open ? "true" : "false");
    }

    function renderIncomeAnalysis(scope, currentMonth, currentYear) {
      const periodIncomes = records.filter((record) => {
        if (record.type !== "income") return false;
        if (record.recordKind === RECORD_KIND_INITIAL_BALANCE) return false;
        const dateText = String(record.date || "");
        if (scope === "month") return dateText.startsWith(currentMonth);
        if (scope === "year") return dateText.startsWith(`${currentYear}-`);
        return true;
      });

      const supportIncome = periodIncomes
        .filter((record) => String(record.category || "") === SUPPORT_INCOME_CATEGORY)
        .reduce((sum, record) => sum + Number(record.amount || 0), 0);

      const salaryIncome = periodIncomes
        .filter((record) => String(record.category || "") === "å›ºå®šè–ªè³‡")
        .reduce((sum, record) => sum + Number(record.amount || 0), 0);

      salaryIncomeValue.textContent = currency.format(salaryIncome);
      supportIncomeValue.textContent = currency.format(supportIncome);
    }

    function normalizeAccounts(input) {
      const seed = Array.isArray(input) && input.length ? input : DEFAULT_ACCOUNTS;
      const normalized = seed
        .map((account, index) => {
          if (!account || typeof account.name !== "string") return null;
          const name = account.name.trim();
          if (!name) return null;
          const id = String(account.id || `acc-${Date.now()}-${index}`).trim();
          const assetType = account.assetType === "long_term" ? "long_term" : "liquid";
          const currentValue = Number(account.currentAmount);
          return {
            id,
            name,
            assetType,
            currentAmount: Number.isFinite(currentValue) && currentValue >= 0 ? currentValue : 0
          };
        })
        .filter(Boolean);
      return normalized.length ? normalized : DEFAULT_ACCOUNTS.slice();
    }

    function loadAccounts() {
      let shouldPersist = false;
      try {
        const raw = localStorage.getItem(ACCOUNT_STORAGE_KEY);
        accounts = normalizeAccounts(raw ? JSON.parse(raw) : null);
        if (!raw) shouldPersist = true;
      } catch {
        accounts = normalizeAccounts(null);
        shouldPersist = true;
      }
      if (shouldPersist) {
        localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(accounts));
      }
    }

    function saveAccounts() {
      markLocalDataUpdated();
      localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(accounts));
      saveToCloud();
    }

    function renderAccountOptions() {
      if (!recordAccountSelect) return;
      const selected = recordAccountSelect.value;
      recordAccountSelect.innerHTML = "";
      accounts.forEach((account, index) => {
        const option = document.createElement("option");
        option.value = account.id;
        option.textContent = `${account.assetType === "long_term" ? "é•·æœŸ" : "æµå‹•"}ï½œ${account.name}`;
        recordAccountSelect.appendChild(option);
        if (index === 0) {
          recordAccountSelect.value = account.id;
        }
      });
      if (selected && accounts.some((account) => account.id === selected)) {
        recordAccountSelect.value = selected;
      }
    }

    function renderAssetSummary() {
      const total = accounts.reduce((sum, account) => sum + Number(account.currentAmount || 0), 0);
      if (assetReportTitle) {
        assetReportTitle.textContent = "å¸³æˆ¶ç¸½é‡‘é¡";
      }
      if (assetReportValue) {
        assetReportValue.textContent = currency.format(total);
      }
    }

    function renderProjectOptions() {
      const selectedProjectId = projectSelect.value;
      projectSelect.innerHTML = "";
      projects.forEach((project, index) => {
        const option = document.createElement("option");
        option.value = project.id;
        option.textContent = `${project.icon} ${project.name}`;
        projectSelect.appendChild(option);
        if (index === 0) projectSelect.value = project.id;
      });

      if (selectedProjectId && projects.some((project) => project.id === selectedProjectId)) {
        projectSelect.value = selectedProjectId;
      }
    }

    function getProjectMeta(projectId) {
      return projects.find((project) => project.id === projectId) || null;
    }

    function normalizeProjects(input) {
      const seed = Array.isArray(input) && input.length ? input : DEFAULT_PROJECTS;
      const cleaned = seed
        .map((project) => {
          if (!project || typeof project.name !== "string") return null;
          const id = String(project.id || "").trim() || `p-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`;
          const name = project.name.trim();
          if (!name) return null;
          const icon = String(project.icon || "ğŸ§¾").trim() || "ğŸ§¾";
          const keywords = Array.isArray(project.keywords)
            ? project.keywords.map((word) => String(word || "").trim()).filter(Boolean)
            : [];
          return { id, name, icon, keywords };
        })
        .filter(Boolean);

      const none = cleaned.find((project) => project.id === "none");
      const rest = cleaned.filter((project) => project.id !== "none");
      return [none || { id: "none", name: "ä¸€èˆ¬", icon: "ğŸ§¾", keywords: [] }, ...rest];
    }

    function ensureProjectOrder() {
      const none = projects.find((project) => project.id === "none") || { id: "none", name: "ä¸€èˆ¬", icon: "ğŸ§¾", keywords: [] };
      const rest = projects.filter((project) => project.id !== "none");
      projects = [none, ...rest];
    }

    function loadProjects() {
      try {
        const raw = localStorage.getItem(PROJECT_STORAGE_KEY);
        projects = normalizeProjects(raw ? JSON.parse(raw) : null);
      } catch {
        projects = normalizeProjects(null);
      }
      saveProjects();
    }

    function saveProjects() {
      markLocalDataUpdated();
      ensureProjectOrder();
      localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(projects));
      saveToCloud();
    }

    function getSupabaseConfig() {
      const url = (localStorage.getItem(SUPABASE_URL_KEY) || SUPABASE_DEFAULT_URL).trim();
      const anonKey = (localStorage.getItem(SUPABASE_ANON_KEY) || SUPABASE_DEFAULT_ANON_KEY).trim();
      return { url, anonKey };
    }

    function isSupabaseConfigured() {
      const { url, anonKey } = getSupabaseConfig();
      return url.length > 0 && anonKey.length > 0;
    }

    function getSupabaseHeaders() {
      const { anonKey } = getSupabaseConfig();
      return {
        apikey: anonKey,
        "Content-Type": "application/json"
      };
    }

    function updateSyncStatus() {
      const el = document.getElementById("syncStatus");
      if (!el) return;
      if (!isSupabaseConfigured()) {
        el.textContent = "æœªè¨­å®šé›²ç«¯";
        el.className = "sync-status";
        return;
      }
      if (navigator.onLine) {
        el.textContent = "å·²é€£ç·š";
        el.className = "sync-status online";
      } else {
        el.textContent = "é›¢ç·šï¼ˆå¾…åŒæ­¥ï¼‰";
        el.className = "sync-status offline";
      }
    }

    async function loadFromCloud() {
      if (!navigator.onLine || !isSupabaseConfigured()) return;
      try {
        const { url } = getSupabaseConfig();
        const endpoint = `${url}/rest/v1/${SYNC_TABLE}?select=${SYNC_PAYLOAD_COLUMN},${SYNC_UPDATED_AT_COLUMN}&${SYNC_KEY_COLUMN}=eq.${encodeURIComponent(SYNC_ROW_ID)}`;
        const response = await fetch(endpoint, {
          method: "GET",
          headers: getSupabaseHeaders()
        });
        if (!response.ok) return;
        const rows = await response.json();
        const cloudRow = Array.isArray(rows) && rows[0] ? rows[0] : null;
        const payload = cloudRow && cloudRow[SYNC_PAYLOAD_COLUMN] ? cloudRow[SYNC_PAYLOAD_COLUMN] : null;
        const cloudUpdatedAt = cloudRow && cloudRow[SYNC_UPDATED_AT_COLUMN] ? String(cloudRow[SYNC_UPDATED_AT_COLUMN]) : "";
        const localUpdatedAt = String(localStorage.getItem(LAST_LOCAL_DATA_UPDATE_KEY) || "");
        if (!payload) return;
        if (cloudUpdatedAt && localUpdatedAt) {
          const cloudTime = Date.parse(cloudUpdatedAt);
          const localTime = Date.parse(localUpdatedAt);
          if (Number.isFinite(cloudTime) && Number.isFinite(localTime) && localTime > cloudTime) {
            return;
          }
        }
        const cloudRecords = Array.isArray(payload.records) ? payload.records : [];
        const cloudCategories = payload.categories != null ? payload.categories : null;
        const cloudProjects = payload.projects != null ? payload.projects : null;
        const cloudAccounts = payload.accounts != null ? payload.accounts : null;

        if (cloudCategories != null) {
          localStorage.setItem(CATEGORY_STORAGE_KEY, JSON.stringify(cloudCategories));
          categories = normalizeCategories(cloudCategories);
        }
        if (cloudProjects != null) {
          localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(cloudProjects));
          projects = normalizeProjects(cloudProjects);
        }
        if (cloudAccounts != null) {
          localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(cloudAccounts));
          accounts = normalizeAccounts(cloudAccounts);
        }
        if (cloudRecords.length >= 0) {
          localStorage.setItem(RECORD_STORAGE_KEY, JSON.stringify(cloudRecords));
          records = migrateRecords(cloudRecords);
        }
      } catch (_) {}
    }

    async function saveToCloud() {
      if (!navigator.onLine || !isSupabaseConfigured()) return;
      try {
        const { url } = getSupabaseConfig();
        const payload = {
          records: records,
          categories: categories,
          projects: projects,
          accounts: accounts
        };
        const endpoint = `${url}/rest/v1/${SYNC_TABLE}?on_conflict=${SYNC_KEY_COLUMN}`;
        await fetch(endpoint, {
          method: "POST",
          headers: {
            ...getSupabaseHeaders(),
            Prefer: "resolution=merge-duplicates,return=minimal"
          },
          body: JSON.stringify([
            {
              [SYNC_KEY_COLUMN]: SYNC_ROW_ID,
              [SYNC_PAYLOAD_COLUMN]: payload,
              [SYNC_UPDATED_AT_COLUMN]: new Date().toISOString()
            }
          ])
        });
      } catch (_) {}
    }

    function parseKeywords(raw) {
      return String(raw || "")
        .split(",")
        .map((text) => text.trim())
        .filter(Boolean);
    }

    function renderProjectManager() {
      projectList.innerHTML = "";
      projects.forEach((project) => {
        const row = document.createElement("div");
        row.className = "project-item";
        row.dataset.id = project.id;
        row.draggable = project.id !== "none" && editingProjectId === null;
        const keywordsText = project.keywords.length ? project.keywords.join("ã€") : "ï¼ˆç„¡é—œéµå­—ï¼‰";

        if (editingProjectId === project.id) {
          row.innerHTML = `
            <div class="project-inline-grid">
              <input data-field="name" type="text" value="${escapeHtml(project.name)}" />
              <input data-field="icon" type="text" value="${escapeHtml(project.icon)}" />
              <input data-field="keywords" type="text" value="${escapeHtml(project.keywords.join(","))}" />
            </div>
            <div class="project-item-actions">
              <button type="button" class="tiny-btn" data-action="save" data-id="${project.id}">å„²å­˜</button>
              <button type="button" class="tiny-btn" data-action="cancel" data-id="${project.id}">å–æ¶ˆ</button>
              <button type="button" class="tiny-btn" data-action="delete" data-id="${project.id}" ${project.id === "none" ? "disabled" : ""}>åˆªé™¤</button>
            </div>
          `;
        } else {
          row.innerHTML = `
            <div class="project-view"><span class="drag-handle">â‹®â‹®</span>${escapeHtml(project.icon)} ${escapeHtml(project.name)} ï½œ ${escapeHtml(keywordsText)}</div>
            <div class="project-item-actions">
              <button type="button" class="tiny-btn" data-action="edit" data-id="${project.id}">ä¿®æ”¹</button>
              <button type="button" class="tiny-btn" data-action="delete" data-id="${project.id}" ${project.id === "none" ? "disabled" : ""}>åˆªé™¤</button>
            </div>
          `;
        }

        projectList.appendChild(row);
      });
    }

    function detectProjectFromText(text) {
      const safe = String(text || "").trim();
      if (!safe) return null;
      for (const project of projects) {
        for (const keyword of project.keywords) {
          if (keyword && safe.includes(keyword)) {
            return project.id;
          }
        }
      }
      return null;
    }

    function migrateRecords(rawRecords) {
      if (!Array.isArray(rawRecords)) return [];
      const byProjectId = new Map(projects.map((project) => [project.id, project]));
      const byProjectName = new Map(projects.map((project) => [project.name.trim().toLowerCase(), project.id]));
      const defaultAccountId = accounts[0] ? accounts[0].id : "";

      return rawRecords
        .filter((record) => record && typeof record === "object")
        .map((record) => {
          const next = { ...record };
          let projectId = String(next.projectId || "").trim();

          if (!projectId) {
            const legacyName = String(next.projectName || next.project || "").trim().toLowerCase();
            if (legacyName && byProjectName.has(legacyName)) {
              projectId = byProjectName.get(legacyName);
            }
          }

          if (!projectId) {
            projectId = detectProjectFromText(next.itemName || next.note || "") || "none";
          }

          if (!byProjectId.has(projectId)) {
            projectId = "none";
          }

          next.projectId = projectId;
          next.myShare = Number.isFinite(Number(next.myShare)) ? Number(next.myShare) : null;
          next.susieShare = Number.isFinite(Number(next.susieShare)) ? Number(next.susieShare) : null;
          next.accountId = String(next.accountId || defaultAccountId);
          next.recordKind = String(next.recordKind || "");
          return next;
        });
    }

    function saveRecords() {
      markLocalDataUpdated();
      localStorage.setItem(RECORD_STORAGE_KEY, JSON.stringify(records));
      saveToCloud();
    }

    function loadRecords() {
      try {
        const raw = localStorage.getItem(RECORD_STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        records = migrateRecords(parsed);
      } catch {
        records = [];
      }
    }

    function updateSummary() {
      const now = new Date();
      const currentYear = String(now.getFullYear());
      const currentMonth = `${currentYear}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      const income = records
        .filter((r) => r.type === "income" && r.recordKind !== RECORD_KIND_INITIAL_BALANCE)
        .reduce((sum, r) => sum + Number(r.amount || 0), 0);
      const expense = records.filter((r) => r.type === "expense").reduce((sum, r) => sum + Number(r.amount || 0), 0);
      const monthIncome = records
        .filter((r) => r.type === "income" && r.recordKind !== RECORD_KIND_INITIAL_BALANCE && String(r.date || "").startsWith(currentMonth))
        .reduce((sum, r) => sum + Number(r.amount || 0), 0);
      const monthExpense = records
        .filter((r) => r.type === "expense" && String(r.date || "").startsWith(currentMonth))
        .reduce((sum, r) => sum + Number(r.amount || 0), 0);
      const yearIncome = records
        .filter((r) => r.type === "income" && r.recordKind !== RECORD_KIND_INITIAL_BALANCE && String(r.date || "").startsWith(`${currentYear}-`))
        .reduce((sum, r) => sum + Number(r.amount || 0), 0);
      const balance = income - expense;
      const monthAvailable = monthIncome - monthExpense;
      balanceEl.textContent = currency.format(balance);
      totalIncomeEl.textContent = currency.format(income);
      totalExpenseEl.textContent = currency.format(expense);
      monthIncomeEl.textContent = currency.format(monthIncome);
      yearIncomeEl.textContent = currency.format(yearIncome);
      monthAvailableValueEl.textContent = currency.format(monthAvailable);
      drawExpensePie(pieScope);
      renderIncomeAnalysis(pieScope, currentMonth, currentYear);
      renderAssetSummary();
    }

    function createRecordRow(record) {
      const tr = document.createElement("tr");
      const typeLabel = record.type === "income" ? "æ”¶å…¥" : "æ”¯å‡º";
      const amountClass = record.type === "income" ? "income" : "expense";
      const typeTagClass = record.type === "income" ? "tag-income" : "tag-expense";
      const itemName = (record.itemName || "").trim() || (record.category || "").trim() || "æœªå‘½å";
      const categoryName = (record.category || "").trim() || "æœªåˆ†é¡";
      const project = getProjectMeta(record.projectId);
      const account = accounts.find((item) => item.id === record.accountId);
      const splitApplied = Number.isFinite(Number(record.myShare)) && Number.isFinite(Number(record.susieShare));
      const susieAmount = Number(record.susieShare);
      const hasSusieExpense = splitApplied && Number.isFinite(susieAmount) && susieAmount > 0;

      if (project && project.id !== "none") {
        tr.classList.add("project-row");
      }
      if (editingRecordId === record.id) {
        tr.classList.add("editing-row");
      }

      const splitText = hasSusieExpense
        ? `ï½œæ‹†åˆ†ï¼šæˆ‘ ${currency.format(Number(record.myShare))}ã€Susie ${currency.format(Number(record.susieShare))}`
        : "";
      const projectTag = project && project.id !== "none"
        ? `<span class="tag tag-project">${project.icon} ${escapeHtml(project.name)}</span>`
        : "";
      const supportTag = record.type === "income" && String(record.category || "") === SUPPORT_INCOME_CATEGORY
        ? `<span class="tag tag-support">ğŸ§¡ è£œå„Ÿæ€§æ”¯æ´</span>`
        : "";
      const initialTag = record.recordKind === RECORD_KIND_INITIAL_BALANCE
        ? `<span class="tag">INITIAL_BALANCE</span>`
        : "";
      const accountTag = account ? `<span class="tag">${escapeHtml(account.name)}</span>` : "";

      tr.innerHTML = `
        <td class="cell-date">${escapeHtml(record.date || "-")}</td>
        <td class="cell-type"><span class="tag ${typeTagClass}">${typeLabel}</span></td>
        <td class="cell-item">
          <span class="item-wrap">
            <span>${escapeHtml(itemName)}</span>
            <span class="tag tag-category">${escapeHtml(categoryName)}</span>
            ${initialTag}
            ${accountTag}
            ${projectTag}
            ${supportTag}
          </span>
        </td>
        <td class="cell-note">${record.note ? escapeHtml(record.note) : "-"}${splitText}</td>
        <td class="cell-amount ${amountClass}">${currency.format(Number(record.amount || 0))}</td>
        <td class="cell-actions">
          <button class="btn-edit" data-id="${record.id}">ä¿®æ”¹</button>
          <button class="btn-delete" data-id="${record.id}">åˆªé™¤</button>
        </td>
      `;
      return tr;
    }

    function renderRecords() {
      recordBody.innerHTML = "";
      if (!records.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "empty";
        td.textContent = "å°šæœªæœ‰ä»»ä½•ç´€éŒ„ï¼Œå…ˆæ–°å¢ç¬¬ä¸€ç­†å§ã€‚";
        tr.appendChild(td);
        recordBody.appendChild(tr);
      } else {
        records
          .slice()
          .sort((a, b) => String(b.date || "").localeCompare(String(a.date || "")))
          .forEach((record) => recordBody.appendChild(createRecordRow(record)));
      }
      recordCountEl.textContent = `${records.length} ç­†ç´€éŒ„`;
      updateSummary();
    }

    function escapeHtml(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function detectCategory(itemName) {
      const text = itemName.trim();
      if (!text) return null;
      for (const category of categories) {
        for (const keyword of category.keywords) {
          if (keyword && text.includes(keyword)) {
            return { categoryName: category.name, keyword };
          }
        }
      }
      return null;
    }

    function detectProject(itemName) {
      const text = itemName.trim();
      if (!text) return null;
      for (const project of projects) {
        for (const keyword of project.keywords) {
          if (keyword && text.includes(keyword)) {
            return { projectId: project.id, projectName: project.name, icon: project.icon, keyword };
          }
        }
      }
      return null;
    }

    function runAutoClassify() {
      const categoryResult = typeInput.value === "expense" ? detectCategory(itemNameInput.value) : null;
      const projectResult = detectProject(itemNameInput.value);
      const hints = [];

      if (categoryResult) {
        categorySelect.value = categoryResult.categoryName;
        hints.push(`åˆ†é¡â†’ã€Œ${categoryResult.categoryName}ã€ï¼ˆ${categoryResult.keyword}ï¼‰`);
      }

      if (projectResult) {
        projectSelect.value = projectResult.projectId;
        hints.push(`å°ˆæ¡ˆâ†’ã€Œ${projectResult.icon} ${projectResult.projectName}ã€ï¼ˆ${projectResult.keyword}ï¼‰`);
      }

      if (hints.length === 0) {
        autoClassifyHint.textContent = "";
        return;
      }

      autoClassifyHint.textContent = `è‡ªå‹•åˆ¤æ–·ï¼š${hints.join("ï¼Œ")}`;
    }

    function setSplitEnabled(enabled) {
      splitEnabled = enabled;
      splitPanel.hidden = !enabled;
      splitToggleBtn.classList.toggle("active", enabled);
      splitToggleBtn.textContent = enabled ? "å–æ¶ˆæ‹†åˆ†" : "æ‹†åˆ†";

      if (enabled) {
        const total = Number(amountInput.value) || 0;
        myShareInput.value = total > 0 ? String(total) : "0";
        susieShareInput.value = "";
      } else {
        myShareInput.value = "";
        susieShareInput.value = "";
      }
      refreshSplitHint();
    }

    function getSplitValues() {
      const total = Number(amountInput.value);
      const susieRaw = susieShareInput.value.trim();
      const susieShare = susieRaw === "" ? 0 : Number(susieRaw);
      const myShare = Number.isFinite(total) && Number.isFinite(susieShare) ? total - susieShare : NaN;
      return { total, myShare, susieShare };
    }

    function refreshSplitHint() {
      if (!splitEnabled) {
        splitHint.textContent = "";
        return;
      }
      const { total, myShare, susieShare } = getSplitValues();

      if (!Number.isFinite(total) || total <= 0) {
        myShareInput.value = "";
        splitHint.textContent = "è«‹å…ˆè¼¸å…¥ç¸½é‡‘é¡ã€‚";
        return;
      }
      if (!Number.isFinite(susieShare) || susieShare < 0) {
        myShareInput.value = "";
        splitHint.textContent = "è«‹è¼¸å…¥æœ‰æ•ˆçš„ Susie é‡‘é¡ã€‚";
        return;
      }
      if (!Number.isFinite(myShare) || myShare < 0) {
        myShareInput.value = "";
        splitHint.textContent = "Susie é‡‘é¡ä¸å¯å¤§æ–¼ç¸½é‡‘é¡ã€‚";
        return;
      }

      myShareInput.value = String(Math.round(myShare));
      const diff = Math.abs((myShare + susieShare) - total);
      splitHint.textContent = diff < 0.5
        ? `æ‹†åˆ†æ­£ç¢ºï¼š${currency.format(total)} = ${currency.format(myShare)} + ${currency.format(susieShare)}`
        : `ç›®å‰ä¸ç›¸ç¬¦ï¼šå·®é¡ ${currency.format(diff)}`;
    }

    function drawExpensePie(scope) {
      const ctx = pieCanvas.getContext("2d");
      if (!ctx) return;
      const now = new Date();
      const currentYear = String(now.getFullYear());
      const currentMonth = `${currentYear}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      const expenseRecords = records.filter((r) => {
        if (r.type !== "expense") return false;
        const dateText = String(r.date || "");
        if (scope === "month") return dateText.startsWith(currentMonth);
        if (scope === "year") return dateText.startsWith(`${currentYear}-`);
        return true;
      });
      const total = expenseRecords.reduce((sum, r) => sum + Number(r.amount || 0), 0);
      ctx.clearRect(0, 0, pieCanvas.width, pieCanvas.height);
      pieLegend.innerHTML = "";
      pieTitle.textContent = scope === "year" ? "ç•¶å¹´åº¦æ¶ˆè²»åˆ†é¡å æ¯”" : "æœ¬æœˆæ¶ˆè²»åˆ†é¡å æ¯”";

      if (total <= 0) {
        pieEmpty.textContent = scope === "year" ? "ç•¶å¹´åº¦å°šç„¡æ”¯å‡ºè³‡æ–™" : "æœ¬æœˆå°šç„¡æ”¯å‡ºè³‡æ–™";
        pieEmpty.style.display = "grid";
        return;
      }

      pieEmpty.style.display = "none";
      const grouped = expenseRecords.reduce((map, record) => {
        const key = record.category || "æœªåˆ†é¡";
        map.set(key, (map.get(key) || 0) + Number(record.amount || 0));
        return map;
      }, new Map());

      const entries = Array.from(grouped.entries()).sort((a, b) => b[1] - a[1]).slice(0, 5);
      let start = -Math.PI / 2;
      entries.forEach(([name, value], index) => {
        const ratio = value / total;
        const angle = ratio * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(68, 68);
        ctx.arc(68, 68, 62, start, start + angle);
        ctx.closePath();
        ctx.fillStyle = PIE_COLORS[index % PIE_COLORS.length];
        ctx.fill();
        start += angle;

        const legend = document.createElement("div");
        legend.className = "legend-item";
        legend.innerHTML = `
          <span class="legend-left"><span class="legend-dot" style="background:${PIE_COLORS[index % PIE_COLORS.length]}"></span>${escapeHtml(name)}</span>
          <span>${Math.round(ratio * 100)}%</span>
        `;
        pieLegend.appendChild(legend);
      });
    }

    function setPieScope(scope) {
      pieScope = scope;
      pieMonthBtn.classList.toggle("active", scope === "month");
      pieYearBtn.classList.toggle("active", scope === "year");
      drawExpensePie(pieScope);
      const now = new Date();
      const currentYear = String(now.getFullYear());
      const currentMonth = `${currentYear}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      renderIncomeAnalysis(pieScope, currentMonth, currentYear);
    }

    function switchTool(toolName) {
      const isHighlighter = toolName === "highlighter";
      showHighlighter.classList.toggle("active", isHighlighter);
      showCalculator.classList.toggle("active", !isHighlighter);
      toolHighlighter.classList.toggle("show", isHighlighter);
      toolCalculator.classList.toggle("show", !isHighlighter);
    }

    function initLeafCanvas() {
      const ratio = window.devicePixelRatio || 1;
      const rect = leafCanvas.getBoundingClientRect();
      leafCanvas.width = Math.max(1, Math.floor(rect.width * ratio));
      leafCanvas.height = Math.max(1, Math.floor(rect.height * ratio));
      const ctx = leafCanvas.getContext("2d");
      if (!ctx) return;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "rgba(252, 234, 82, 0.5)";
      ctx.lineWidth = 18;
    }

    function getLeafPos(event) {
      const rect = leafCanvas.getBoundingClientRect();
      return { x: event.clientX - rect.left, y: event.clientY - rect.top };
    }

    function startDraw(event) {
      drawing = true;
      lastPoint = getLeafPos(event);
    }

    function draw(event) {
      if (!drawing) return;
      const ctx = leafCanvas.getContext("2d");
      if (!ctx) return;
      const next = getLeafPos(event);
      ctx.beginPath();
      ctx.moveTo(lastPoint.x, lastPoint.y);
      ctx.lineTo(next.x, next.y);
      ctx.stroke();
      lastPoint = next;
    }

    function endDraw() {
      drawing = false;
    }

    function safeEval(expression) {
      const normalized = expression.replace(/%/g, "/100");
      if (!/^[\d+\-*/().\s]+$/.test(normalized)) return null;
      try {
        const result = Function(`"use strict"; return (${normalized});`)();
        return Number.isFinite(result) ? result : null;
      } catch {
        return null;
      }
    }

    form.addEventListener("submit", (event) => {
      event.preventDefault();
      const isEditing = Boolean(editingRecordId);
      const editingRecord = isEditing ? records.find((item) => item.id === editingRecordId) : null;
      const amount = Number(amountInput.value);
      if (!Number.isFinite(amount) || amount <= 0) {
        alert("è«‹è¼¸å…¥æ­£ç¢ºçš„é‡‘é¡ã€‚");
        return;
      }

      const record = {
        id: editingRecordId || crypto.randomUUID(),
        date: dateInput.value,
        type: typeInput.value,
        itemName: itemNameInput.value.trim(),
        category: categorySelect.value,
        projectId: projectSelect.value,
        accountId: recordAccountSelect ? recordAccountSelect.value : "",
        amount,
        note: noteInput.value.trim(),
        myShare: null,
        susieShare: null,
        recordKind: editingRecord ? String(editingRecord.recordKind || "") : ""
      };
      if (!record.date || !record.itemName || !record.category) {
        alert("è«‹å®Œæ•´å¡«å¯«æ—¥æœŸã€é …ç›®åç¨±èˆ‡åˆ†é¡ã€‚");
        return;
      }
      if (!record.accountId) {
        alert("è«‹å…ˆé¸æ“‡å¸³æˆ¶ã€‚");
        return;
      }

      if (splitEnabled) {
        const { myShare, susieShare } = getSplitValues();
        const diff = Math.abs((myShare + susieShare) - amount);
        if (!Number.isFinite(myShare) || !Number.isFinite(susieShare) || myShare < 0 || susieShare < 0 || diff >= 0.5) {
          alert("è«‹ç¢ºèª Susie é‡‘é¡æœ‰æ•ˆï¼Œä¸”ä¸å¯å¤§æ–¼ç¸½é‡‘é¡ã€‚");
          return;
        }
        if (susieShare > 0 && !record.note) {
          alert("ç•¶ Susie æœ‰åˆ†å¸³é‡‘é¡æ™‚ï¼Œè«‹å¡«å¯«å‚™è¨»ã€‚");
          return;
        }
        record.myShare = myShare;
        record.susieShare = susieShare;
      }

      if (editingRecordId) {
        const targetIndex = records.findIndex((item) => item.id === editingRecordId);
        if (targetIndex >= 0) {
          records[targetIndex] = record;
        } else {
          records.push(record);
        }
      } else {
        records.push(record);
      }

      saveRecords();
      exitEditMode(false);
      renderRecords();
      itemNameInput.value = "";
      amountInput.value = "";
      noteInput.value = "";
      autoClassifyHint.textContent = "";
      setSplitEnabled(false);
      itemNameInput.focus();
      showToast(isEditing ? "ç´€éŒ„å·²æ›´æ–°" : "ç´€éŒ„å·²æ–°å¢");
    });

    form.addEventListener("reset", () => {
      setTimeout(() => {
        exitEditMode();
        autoClassifyHint.textContent = "";
        renderCategoryOptions();
        projectSelect.value = "none";
        if (recordAccountSelect && recordAccountSelect.options.length > 0) {
          recordAccountSelect.value = recordAccountSelect.options[0].value;
        }
        setSplitEnabled(false);
      }, 0);
    });

    itemNameInput.addEventListener("input", runAutoClassify);
    categorySelect.addEventListener("change", () => {
      if (!editingRecordId) return;
      itemNameInput.value = categorySelect.value;
      autoClassifyHint.textContent = "å·²ä¾æ–°é¡åˆ¥åŒæ­¥æ›´æ–°é …ç›®åç¨±";
    });
    projectManagerToggleBtn.addEventListener("click", () => {
      setProjectManagerOpen(projectManagerPanel.hidden);
    });
    typeIncomeBtn.addEventListener("click", () => setType("income"));
    typeExpenseBtn.addEventListener("click", () => setType("expense"));
    amountInput.addEventListener("input", refreshSplitHint);
    susieShareInput.addEventListener("input", refreshSplitHint);
    splitToggleBtn.addEventListener("click", () => setSplitEnabled(!splitEnabled));
    pieMonthBtn.addEventListener("click", () => setPieScope("month"));
    pieYearBtn.addEventListener("click", () => setPieScope("year"));
    addProjectBtn.addEventListener("click", () => {
      const name = projectNameInput.value.trim();
      const icon = projectIconInput.value.trim() || "ğŸ§¾";
      const keywords = parseKeywords(projectKeywordsInput.value);
      if (!name) {
        alert("è«‹å…ˆè¼¸å…¥å°ˆæ¡ˆåç¨±ã€‚");
        return;
      }

      projects.push({
        id: `p-${Date.now()}`,
        name,
        icon,
        keywords
      });
      saveProjects();
      editingProjectId = null;
      renderProjectOptions();
      renderProjectManager();
      projectNameInput.value = "";
      projectIconInput.value = "";
      projectKeywordsInput.value = "";
    });

    projectList.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const button = target.closest("button");
      if (!(button instanceof HTMLButtonElement)) return;
      const action = button.dataset.action;
      const id = button.dataset.id;
      if (!action || !id) return;

      const project = projects.find((item) => item.id === id);
      if (!project) return;

      if (action === "edit") {
        if (project.id === "none") return;
        editingProjectId = id;
        renderProjectManager();
        return;
      }

      if (action === "cancel") {
        editingProjectId = null;
        renderProjectManager();
        return;
      }

      if (action === "save") {
        const row = button.closest(".project-item");
        if (!row) return;

        const nameInput = row.querySelector('input[data-field="name"]');
        const iconInput = row.querySelector('input[data-field="icon"]');
        const keywordsInput = row.querySelector('input[data-field="keywords"]');
        if (!(nameInput instanceof HTMLInputElement) || !(iconInput instanceof HTMLInputElement) || !(keywordsInput instanceof HTMLInputElement)) {
          return;
        }

        const safeName = nameInput.value.trim();
        if (!safeName) {
          alert("å°ˆæ¡ˆåç¨±ä¸å¯ç‚ºç©ºã€‚");
          return;
        }

        project.name = safeName;
        project.icon = iconInput.value.trim() || "ğŸ§¾";
        project.keywords = parseKeywords(keywordsInput.value);
        saveProjects();
        editingProjectId = null;
        renderProjectOptions();
        renderProjectManager();
        return;
      }

      if (action === "delete") {
        if (id === "none") return;
        projects = projects.filter((item) => item.id !== id);
        records = records.map((record) => (
          record.projectId === id ? { ...record, projectId: "none" } : record
        ));
        saveProjects();
        saveRecords();
        editingProjectId = null;
        renderProjectOptions();
        renderProjectManager();
        renderRecords();
      }
    });

    projectList.addEventListener("dragstart", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const row = target.closest(".project-item");
      if (!row) return;
      const id = row.dataset.id;
      if (!id || id === "none") return;

      draggingProjectId = id;
      row.classList.add("dragging");
    });

    projectList.addEventListener("dragend", () => {
      draggingProjectId = null;
      projectList.querySelectorAll(".project-item").forEach((row) => {
        row.classList.remove("dragging");
        row.classList.remove("drag-over");
      });
    });

    projectList.addEventListener("dragover", (event) => {
      event.preventDefault();
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const row = target.closest(".project-item");
      if (!row) return;

      projectList.querySelectorAll(".project-item").forEach((item) => item.classList.remove("drag-over"));
      row.classList.add("drag-over");
    });

    projectList.addEventListener("drop", (event) => {
      event.preventDefault();
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const row = target.closest(".project-item");
      if (!row || !draggingProjectId) return;

      const targetId = row.dataset.id;
      if (!targetId || targetId === draggingProjectId) return;

      const fromIndex = projects.findIndex((project) => project.id === draggingProjectId);
      let toIndex = projects.findIndex((project) => project.id === targetId);
      if (fromIndex < 0 || toIndex < 0) return;
      if (fromIndex === 0) return;

      const [moved] = projects.splice(fromIndex, 1);
      if (targetId === "none") {
        toIndex = 1;
      } else if (fromIndex < toIndex) {
        toIndex -= 1;
      }

      projects.splice(Math.max(1, toIndex), 0, moved);
      saveProjects();
      renderProjectOptions();
      renderProjectManager();
    });

    recordBody.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const button = target.closest("button");
      if (!(button instanceof HTMLButtonElement)) return;
      const id = button.dataset.id;
      if (!id) return;
      if (button.classList.contains("btn-edit")) {
        beginEditRecord(id);
        return;
      }
      if (button.classList.contains("btn-delete")) {
        records = records.filter((r) => r.id !== id);
        if (editingRecordId === id) {
          exitEditMode(false);
        }
        saveRecords();
        renderRecords();
        showToast("ç´€éŒ„å·²åˆªé™¤");
      }
    });

    robotBtn.addEventListener("click", () => {
      robotPanel.classList.toggle("show");
      robotPanel.setAttribute("aria-hidden", robotPanel.classList.contains("show") ? "false" : "true");
      if (robotPanel.classList.contains("show")) initLeafCanvas();
    });

    showHighlighter.addEventListener("click", () => switchTool("highlighter"));
    showCalculator.addEventListener("click", () => switchTool("calculator"));

    leafCanvas.addEventListener("pointerdown", startDraw);
    leafCanvas.addEventListener("pointermove", draw);
    leafCanvas.addEventListener("pointerup", endDraw);
    leafCanvas.addEventListener("pointerleave", endDraw);
    clearLeaf.addEventListener("click", () => {
      const ctx = leafCanvas.getContext("2d");
      if (!ctx) return;
      ctx.clearRect(0, 0, leafCanvas.width, leafCanvas.height);
    });

    calcGrid.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLButtonElement)) return;
      const { value, action } = target.dataset;
      if (action === "clear") {
        calcExpression = "0";
      } else if (action === "delete") {
        calcExpression = calcExpression.length > 1 ? calcExpression.slice(0, -1) : "0";
      } else if (action === "equal") {
        const result = safeEval(calcExpression);
        calcExpression = result === null ? "éŒ¯èª¤" : String(result);
      } else if (value) {
        calcExpression = calcExpression === "0" || calcExpression === "éŒ¯èª¤" ? value : calcExpression + value;
      }
      calcScreen.value = calcExpression;
    });

    window.addEventListener("resize", () => {
      if (robotPanel.classList.contains("show")) {
        initLeafCanvas();
      }
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }

    const syncConfigToggle = document.getElementById("syncConfigToggle");
    const syncConfigPanel = document.getElementById("syncConfigPanel");
    const supabaseUrlInput = document.getElementById("supabaseUrl");
    const supabaseAnonKeyInput = document.getElementById("supabaseAnonKey");
    const saveSupabaseConfigBtn = document.getElementById("saveSupabaseConfig");
    const installBanner = document.getElementById("installBanner");
    const installText = document.getElementById("installText");
    const installBtn = document.getElementById("installBtn");
    const dismissInstallBtn = document.getElementById("dismissInstallBtn");
    const INSTALL_DISMISS_KEY = "money-app-install-banner-dismissed-v1";
    let deferredInstallPrompt = null;

    function isStandaloneMode() {
      return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
    }

    function isIosDevice() {
      const ua = navigator.userAgent || "";
      return /iPad|iPhone|iPod/.test(ua);
    }

    function shouldShowInstallBanner() {
      if (isStandaloneMode()) return false;
      return localStorage.getItem(INSTALL_DISMISS_KEY) !== "1";
    }

    function renderInstallBanner() {
      if (!installBanner || !installBtn || !installText) return;
      if (!shouldShowInstallBanner()) {
        installBanner.classList.remove("show");
        return;
      }

      if (deferredInstallPrompt) {
        installText.textContent = "å®‰è£åˆ°ä¸»ç•«é¢å¾Œï¼Œæœƒåƒ App ä¸€æ¨£é–‹å•Ÿï¼ˆç„¡ç¶²å€åˆ—ï¼‰ã€‚";
        installBtn.hidden = false;
      } else if (isIosDevice()) {
        installText.textContent = "iPhone è«‹é» Safari åˆ†äº«æŒ‰éˆ•ï¼Œå†é¸ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚";
        installBtn.hidden = true;
      } else {
        installText.textContent = "å¯å°‡æ­¤é åŠ å…¥ä¸»ç•«é¢ï¼Œåƒ App ä¸€æ¨£é–‹å•Ÿã€‚";
        installBtn.hidden = true;
      }
      installBanner.classList.add("show");
    }

    window.addEventListener("beforeinstallprompt", (event) => {
      event.preventDefault();
      deferredInstallPrompt = event;
      renderInstallBanner();
    });

    if (installBtn) {
      installBtn.addEventListener("click", async () => {
        if (!deferredInstallPrompt) return;
        deferredInstallPrompt.prompt();
        try {
          await deferredInstallPrompt.userChoice;
        } catch (_) {}
        deferredInstallPrompt = null;
        localStorage.setItem(INSTALL_DISMISS_KEY, "1");
        renderInstallBanner();
      });
    }

    if (dismissInstallBtn) {
      dismissInstallBtn.addEventListener("click", () => {
        localStorage.setItem(INSTALL_DISMISS_KEY, "1");
        renderInstallBanner();
      });
    }

    if (syncConfigToggle && syncConfigPanel) {
      syncConfigToggle.addEventListener("click", () => {
        const show = syncConfigPanel.hidden;
        syncConfigPanel.hidden = !show;
        if (show) {
          const cfg = getSupabaseConfig();
          supabaseUrlInput.value = cfg.url;
          supabaseAnonKeyInput.value = cfg.anonKey;
        }
      });
    }
    if (saveSupabaseConfigBtn && supabaseUrlInput && supabaseAnonKeyInput) {
      saveSupabaseConfigBtn.addEventListener("click", () => {
        const url = supabaseUrlInput.value.trim();
        const anonKey = supabaseAnonKeyInput.value.trim();
        if (!url || !anonKey) {
          alert("è«‹å¡«å¯« Supabase URL èˆ‡ Anon Keyã€‚");
          return;
        }
        localStorage.setItem(SUPABASE_URL_KEY, url);
        localStorage.setItem(SUPABASE_ANON_KEY, anonKey);
        updateSyncStatus();
        alert("å·²å„²å­˜ï¼Œä¹‹å¾Œé–‹å•Ÿ App æœƒå¾é›²ç«¯è¼‰å…¥ï¼Œè®Šæ›´ä¹Ÿæœƒè‡ªå‹•åŒæ­¥ã€‚");
      });
    }

    window.addEventListener("online", () => {
      updateSyncStatus();
      saveToCloud().then(() => loadFromCloud()).then(() => {
        loadRecords();
        loadCategories();
        loadProjects();
        loadAccounts();
        renderRecords();
        renderCategoryOptions();
        renderProjectOptions();
        renderProjectManager();
        renderAccountOptions();
        renderAssetSummary();
      });
    });
    window.addEventListener("offline", updateSyncStatus);

    // å¾å…¶ä»–é è¿”å›ï¼ˆä¾‹å¦‚è³‡ç”¢è¨­å®šé ï¼‰æ™‚ï¼Œç¢ºä¿ç”¨æœ€æ–°æœ¬æ©Ÿè³‡æ–™é‡ç¹ªã€‚
    function refreshFromLocalStorage() {
      loadAccounts();
      loadRecords();
      renderAccountOptions();
      renderRecords();
      renderAssetSummary();
    }

    window.addEventListener("pageshow", () => {
      refreshFromLocalStorage();
    });

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) {
        refreshFromLocalStorage();
      }
    });

    (async function init() {
      if (isStandaloneMode()) {
        document.body.classList.add("standalone");
      }
      renderInstallBanner();
      setTodayDate();
      loadCategories();
      loadProjects();
      loadAccounts();
      await loadFromCloud();
      loadRecords();
      loadCategories();
      loadProjects();
      loadAccounts();
      setType("income");
      setProjectManagerOpen(false);
      renderProjectOptions();
      renderProjectManager();
      renderAccountOptions();
      renderAssetSummary();
      setPieScope("month");
      renderRecords();
      calcScreen.value = calcExpression;
      updateSyncStatus();
    })();
  </script>
</body>
</html>
