<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>è³‡ç”¢è¨­å®š</title>
  <style>
    :root {
      --bg: #f7efe2;
      --card: #fffaf4;
      --line: #e5d7c8;
      --text: #46362d;
      --subtle: #7a6357;
      --accent: #b57542;
      --accent-deep: #975d33;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color: var(--text);
      background: var(--bg);
      padding: 16px;
    }
    .wrap {
      width: 100%;
      max-width: 820px;
      margin: 0 auto;
      display: grid;
      gap: 12px;
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--card);
      padding: 14px;
      display: grid;
      gap: 10px;
    }
    h1 {
      margin: 0;
      font-size: 1.15rem;
    }
    p {
      margin: 0;
      color: var(--subtle);
      font-size: 0.9rem;
    }
    .grid {
      display: grid;
      gap: 8px;
      grid-template-columns: 1.2fr 0.8fr 1fr auto;
    }
    input, select, button, a {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      min-height: 44px;
      font-size: 0.92rem;
      color: var(--text);
      background: #fff9f2;
      text-decoration: none;
    }
    button {
      cursor: pointer;
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff8f0;
    }
    .btn-primary:hover {
      background: var(--accent-deep);
      border-color: var(--accent-deep);
    }
    .btn-ghost {
      background: #fffdf9;
    }
    .btn-danger {
      background: #fff2f0;
      border-color: #e3c8c2;
      color: #8b4a42;
    }
    .list {
      display: grid;
      gap: 8px;
    }
    .row {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fffdf9;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .meta {
      color: var(--subtle);
      font-size: 0.82rem;
    }
    .row-actions {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .row-actions button {
      min-height: 36px;
      padding: 6px 10px;
      font-size: 0.82rem;
    }
    .head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .robot-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 62px;
      height: 62px;
      border-radius: 50%;
      border: 1px solid #e3c2a3;
      background: linear-gradient(145deg, #f6dec1, #f0c899);
      box-shadow: 0 8px 18px rgba(129, 81, 46, 0.25);
      font-size: 1.5rem;
      z-index: 30;
    }
    .robot-panel {
      position: fixed;
      right: 18px;
      bottom: 92px;
      width: min(360px, calc(100vw - 24px));
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #fff8ef;
      box-shadow: 0 10px 24px rgba(92, 57, 34, 0.12);
      padding: 12px;
      z-index: 30;
      display: none;
    }
    .robot-panel.show { display: block; }
    .tool-title { margin: 0 0 8px; color: #6f4d3a; font-size: 0.93rem; font-weight: 700; }
    .tool-list { margin: 0 0 10px; padding-left: 18px; color: var(--subtle); font-size: 0.86rem; line-height: 1.55; }
    .calc { border: 1px solid var(--line); border-radius: 12px; padding: 10px; background: #fbf1e3; }
    .calc-screen { width: 100%; margin-bottom: 8px; text-align: right; font-weight: 700; font-size: 1rem; background: #fff8f0; }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .calc-grid button { padding: 9px 0; font-weight: 700; }
    @media (max-width: 520px) {
      body { padding: 10px; }
      .grid { grid-template-columns: 1fr; }
      .robot-btn { width: 54px; height: 54px; right: 12px; bottom: 12px; }
      .robot-panel { right: 12px; bottom: 76px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="head">
        <h1>è³‡ç”¢è¨­å®šï¼ˆé–‹å¸³ï¼‰</h1>
        <a href="./index.html">è¿”å›è¨˜å¸³é¦–é </a>
      </div>
      <p>è¨­å®šå¸³æˆ¶ç›®å‰é‡‘é¡æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å»ºç«‹/æ›´æ–°ä¸€ç­† <strong>INITIAL_BALANCE</strong>ï¼Œä¸”ä¸åˆ—å…¥æœ¬æœˆæ”¶å…¥ã€‚</p>
    </section>

    <section class="card">
      <div class="grid">
        <input id="accountName" type="text" placeholder="å¸³æˆ¶åç¨±ï¼ˆå¦‚ï¼šç¾é‡‘ï¼‰" />
        <select id="assetType">
          <option value="liquid">æµå‹•è³‡ç”¢</option>
          <option value="long_term">é•·æœŸè³‡ç”¢</option>
        </select>
        <input id="currentAmount" type="number" min="0" step="1" placeholder="ç•¶å‰é‡‘é¡" />
        <button id="saveBtn" type="button" class="btn-primary">å„²å­˜</button>
      </div>
      <div class="grid" style="grid-template-columns: 1fr;">
        <button id="cancelEditBtn" type="button" class="btn-ghost">å–æ¶ˆç·¨è¼¯</button>
      </div>
      <div id="accountList" class="list"></div>
    </section>
  </main>

  <button id="robotBtn" class="robot-btn" title="é–‹å•Ÿå°å¹«æ‰‹">ğŸ¤–</button>
  <aside id="robotPanel" class="robot-panel" aria-hidden="true">
    <p class="tool-title">å°å¹«æ‰‹å·¥å…·ç®±</p>
    <ol class="tool-list">
      <li>è¨ˆç®—æ©Ÿï¼Œç›´æ¥åœ¨é é¢æ—å”åŠ©ä½ åšç°¡å–®è¨ˆç®—</li>
    </ol>
    <section id="toolCalculator" class="tool-body" style="display:block;">
      <div class="calc">
        <input id="calcScreen" class="calc-screen" type="text" value="0" readonly />
        <div class="calc-grid" id="calcGrid">
          <button type="button" data-action="clear">C</button>
          <button type="button" data-action="delete">DEL</button>
          <button type="button" data-value="%">%</button>
          <button type="button" data-value="/">/</button>
          <button type="button" data-value="7">7</button>
          <button type="button" data-value="8">8</button>
          <button type="button" data-value="9">9</button>
          <button type="button" data-value="*">*</button>
          <button type="button" data-value="4">4</button>
          <button type="button" data-value="5">5</button>
          <button type="button" data-value="6">6</button>
          <button type="button" data-value="-">-</button>
          <button type="button" data-value="1">1</button>
          <button type="button" data-value="2">2</button>
          <button type="button" data-value="3">3</button>
          <button type="button" data-value="+">+</button>
          <button type="button" data-value="0">0</button>
          <button type="button" data-value=".">.</button>
          <button type="button" data-action="equal" style="grid-column: span 2;">=</button>
        </div>
      </div>
    </section>
  </aside>

  <script>
    const ACCOUNT_STORAGE_KEY = "money-app-accounts-v1";
    const RECORD_STORAGE_KEY = "money-app-records-v1";
    const LAST_LOCAL_DATA_UPDATE_KEY = "money-app-last-local-data-update-at";
    const RECORD_KIND_INITIAL_BALANCE = "INITIAL_BALANCE";
    const DEFAULT_ACCOUNTS = [
      { id: "acc-cash", name: "ç¾é‡‘", assetType: "liquid", currentAmount: 0 },
      { id: "acc-bank", name: "æ´»å­˜", assetType: "liquid", currentAmount: 0 },
      { id: "acc-fund", name: "åŸºé‡‘", assetType: "long_term", currentAmount: 0 }
    ];
    const currency = new Intl.NumberFormat("zh-TW", { style: "currency", currency: "TWD", maximumFractionDigits: 0 });

    const accountNameInput = document.getElementById("accountName");
    const assetTypeSelect = document.getElementById("assetType");
    const currentAmountInput = document.getElementById("currentAmount");
    const saveBtn = document.getElementById("saveBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const accountList = document.getElementById("accountList");

    let accounts = [];
    let records = [];
    let editingAccountId = null;

    function normalizeAccounts(input) {
      const seed = Array.isArray(input) && input.length ? input : DEFAULT_ACCOUNTS;
      const normalized = seed.map((account, index) => {
        if (!account || typeof account.name !== "string") return null;
        const name = account.name.trim();
        if (!name) return null;
        const id = String(account.id || `acc-${Date.now()}-${index}`).trim();
        const assetType = account.assetType === "long_term" ? "long_term" : "liquid";
        const amount = Number(account.currentAmount);
        return { id, name, assetType, currentAmount: Number.isFinite(amount) && amount >= 0 ? amount : 0 };
      }).filter(Boolean);
      return normalized.length ? normalized : DEFAULT_ACCOUNTS.slice();
    }

    function loadData() {
      try {
        const rawAccounts = localStorage.getItem(ACCOUNT_STORAGE_KEY);
        accounts = normalizeAccounts(rawAccounts ? JSON.parse(rawAccounts) : null);
      } catch {
        accounts = normalizeAccounts(null);
      }
      try {
        const rawRecords = localStorage.getItem(RECORD_STORAGE_KEY);
        const parsedRecords = rawRecords ? JSON.parse(rawRecords) : [];
        records = Array.isArray(parsedRecords) ? parsedRecords : [];
      } catch {
        records = [];
      }
    }

    function saveAccounts() {
      localStorage.setItem(LAST_LOCAL_DATA_UPDATE_KEY, new Date().toISOString());
      localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(accounts));
    }

    function saveRecords() {
      localStorage.setItem(LAST_LOCAL_DATA_UPDATE_KEY, new Date().toISOString());
      localStorage.setItem(RECORD_STORAGE_KEY, JSON.stringify(records));
    }

    function escapeHtml(text) {
      return String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function resetForm() {
      editingAccountId = null;
      saveBtn.textContent = "å„²å­˜";
      accountNameInput.value = "";
      assetTypeSelect.value = "liquid";
      currentAmountInput.value = "";
    }

    function renderAccounts() {
      accountList.innerHTML = "";
      accounts.forEach((account) => {
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.id = account.id;
        row.innerHTML = `
          <div>
            <div>${escapeHtml(account.name)}</div>
            <div class="meta">${account.assetType === "long_term" ? "é•·æœŸè³‡ç”¢" : "æµå‹•è³‡ç”¢"}</div>
          </div>
          <div class="row-actions">
            <strong>${currency.format(Number(account.currentAmount || 0))}</strong>
            <button type="button" class="btn-ghost" data-action="edit" data-id="${account.id}">ç·¨è¼¯</button>
            <button type="button" class="btn-danger" data-action="delete" data-id="${account.id}">åˆªé™¤</button>
          </div>
        `;
        accountList.appendChild(row);
      });
    }

    function saveInitialBalance() {
      const isEditing = Boolean(editingAccountId);
      const name = String(accountNameInput.value || "").trim();
      const amount = Number(currentAmountInput.value);
      const assetType = assetTypeSelect.value === "long_term" ? "long_term" : "liquid";
      if (!name) {
        alert("è«‹è¼¸å…¥å¸³æˆ¶åç¨±ã€‚");
        return;
      }
      if (!Number.isFinite(amount) || amount < 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ã€‚");
        return;
      }

      const existingById = editingAccountId ? accounts.find((account) => account.id === editingAccountId) : null;
      const existingByName = accounts.find((account) => account.name === name);
      const accountId = existingById
        ? existingById.id
        : (existingByName ? existingByName.id : `acc-${Date.now()}`);
      const next = { id: accountId, name, assetType, currentAmount: amount };
      if (accounts.some((account) => account.id === accountId)) {
        accounts = accounts.map((account) => (account.id === accountId ? next : account));
      } else {
        accounts.push(next);
      }

      records = records.filter((record) => !(record.recordKind === RECORD_KIND_INITIAL_BALANCE && record.accountId === accountId));
      records.push({
        id: crypto.randomUUID(),
        date: new Date().toISOString().slice(0, 10),
        type: "income",
        itemName: `${name} æœŸåˆé¤˜é¡`,
        category: "æœŸåˆé¤˜é¡",
        projectId: "none",
        accountId,
        amount,
        note: "é–‹å¸³",
        myShare: null,
        susieShare: null,
        recordKind: RECORD_KIND_INITIAL_BALANCE
      });

      saveAccounts();
      saveRecords();
      renderAccounts();
      resetForm();
      alert(isEditing ? "å·²æ›´æ–°å¸³æˆ¶èˆ‡æœŸåˆé¤˜é¡ã€‚" : "å·²å„²å­˜å¸³æˆ¶èˆ‡æœŸåˆé¤˜é¡ã€‚");
    }

    function beginEditAccount(accountId) {
      const target = accounts.find((account) => account.id === accountId);
      if (!target) return;
      editingAccountId = accountId;
      accountNameInput.value = target.name;
      assetTypeSelect.value = target.assetType === "long_term" ? "long_term" : "liquid";
      currentAmountInput.value = String(Number(target.currentAmount || 0));
      saveBtn.textContent = "æ›´æ–°";
      accountNameInput.focus();
    }

    function deleteAccount(accountId) {
      if (accounts.length <= 1) {
        alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å¸³æˆ¶ã€‚");
        return;
      }
      const target = accounts.find((account) => account.id === accountId);
      if (!target) return;
      const ok = confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${target.name}ã€å—ï¼Ÿ`);
      if (!ok) return;

      const fallback = accounts.find((account) => account.id !== accountId);
      if (!fallback) return;
      accounts = accounts.filter((account) => account.id !== accountId);

      records = records
        .filter((record) => !(record.recordKind === RECORD_KIND_INITIAL_BALANCE && record.accountId === accountId))
        .map((record) => {
          if (record.accountId === accountId) {
            return { ...record, accountId: fallback.id };
          }
          return record;
        });

      saveAccounts();
      saveRecords();
      if (editingAccountId === accountId) {
        resetForm();
      }
      renderAccounts();
    }

    accountList.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const button = target.closest("button");
      if (!(button instanceof HTMLButtonElement)) return;
      const action = button.dataset.action;
      const accountId = button.dataset.id;
      if (!action || !accountId) return;
      if (action === "edit") {
        beginEditAccount(accountId);
      } else if (action === "delete") {
        deleteAccount(accountId);
      }
    });

    saveBtn.addEventListener("click", saveInitialBalance);
    cancelEditBtn.addEventListener("click", resetForm);
    loadData();
    saveAccounts();
    renderAccounts();

    (function initRobot() {
      const robotBtn = document.getElementById("robotBtn");
      const robotPanel = document.getElementById("robotPanel");
      const calcScreen = document.getElementById("calcScreen");
      const calcGrid = document.getElementById("calcGrid");
      let calcExpression = "0";
      function safeEval(expr) {
        const n = (expr || "").replace(/%/g, "/100");
        if (!/^[\d+\-*/().\s]+$/.test(n)) return null;
        try {
          const r = Function('"use strict"; return (' + n + ');')();
          return Number.isFinite(r) ? r : null;
        } catch { return null; }
      }
      if (robotBtn && robotPanel) {
        robotBtn.addEventListener("click", () => {
          robotPanel.classList.toggle("show");
          robotPanel.setAttribute("aria-hidden", robotPanel.classList.contains("show") ? "false" : "true");
        });
      }
      if (calcGrid && calcScreen) {
        calcGrid.addEventListener("click", (e) => {
          const btn = e.target;
          if (!(btn instanceof HTMLButtonElement)) return;
          const { value, action } = btn.dataset;
          if (action === "clear") calcExpression = "0";
          else if (action === "delete") calcExpression = calcExpression.length > 1 ? calcExpression.slice(0, -1) : "0";
          else if (action === "equal") { const r = safeEval(calcExpression); calcExpression = r === null ? "éŒ¯èª¤" : String(r); }
          else if (value) calcExpression = (calcExpression === "0" || calcExpression === "éŒ¯èª¤") ? value : calcExpression + value;
          calcScreen.value = calcExpression;
        });
      }
    })();
  </script>
</body>
</html>
